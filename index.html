<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ”¿åºœç¸½é ç®—è§€æ¸¬ç«™ (v88 é›™ä¿éšªæ•´åˆç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* --- åŸºç¤è¨­å®š (v56 ç¾ä»£é«˜å°æ¯”é…è‰²) --- */
        :root {
            --bg-color: #F8F8F8; --primary-color: #070707; --secondary-color: #086788;
            --accent-color: #F0C808; --highlight-color: #A6DAEE;
            --danger-color: #E74C3C; --warning-color: var(--accent-color); --success-color: var(--secondary-color);
            --card-bg: #FFFFFF; --border-color: #e0e0e0;
            --party-kmt: #000095; --party-dpp: #1b9431; --party-tpp: #28c7c7; --party-npp: #f9be01; --party-other: #7f8c8d;
        }
        * { box-sizing: border-box; }
        body { font-family: "Noto Sans TC", sans-serif; background-color: var(--bg-color); margin: 0; line-height: 1.6; color: var(--primary-color); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Header */
        header { background-color: var(--card-bg); color: var(--primary-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-bottom: 3px solid var(--secondary-color); }
        header h1 { margin: 0; font-size: 1.4rem; cursor: pointer; white-space: nowrap; font-weight: 900; letter-spacing: 1px; color: var(--secondary-color); }
        header nav { display: flex; gap: 10px; }
        header nav button { background: transparent; border: 2px solid var(--secondary-color); color: var(--secondary-color); padding: 6px 12px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; font-weight: bold; }
        header nav button:hover { background: var(--secondary-color); color: white; transform: translateY(-1px); }
        .nav-active { background: var(--secondary-color) !important; color: white !important; border-color: var(--secondary-color) !important; }
        @media (max-width: 680px) { header { flex-direction: column; gap: 15px; padding: 1rem; } header nav { width: 100%; justify-content: center; flex-wrap: wrap; } header nav button { flex: 1; min-width: 80px; text-align: center; } }

        /* Main */
        main { padding: 2rem; max-width: 1200px; margin: 0 auto; flex: 1; width: 100%; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Footer */
        footer { background-color: var(--bg-color); color: #555; padding: 3rem 1rem; text-align: center; margin-top: auto; font-size: 0.9rem; border-top: 4px solid var(--secondary-color); }
        .footer-content { max-width: 800px; margin: 0 auto; }
        .footer-disclaimer { background: rgba(8, 103, 136, 0.1); color: var(--secondary-color); display: inline-block; padding: 8px 15px; border-radius: 8px; border: 1px solid var(--secondary-color); font-weight: bold; margin-top: 10px; }

        /* Components */
        .section-title { text-align: center; margin: 3rem 0 1.5rem 0; color: var(--primary-color); position: relative; font-weight: 800; }
        .section-title::after { content: ''; display: block; width: 60px; height: 5px; background: var(--accent-color); margin: 15px auto 0; border-radius: 3px; }
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; overflow: hidden; border: 1px solid var(--border-color); }
        .card h3 { color: var(--primary-color); margin-top: 0; font-weight: 700; border-bottom: 2px solid var(--bg-color); padding-bottom: 10px; position: relative; }
        .card h3::before { content:''; position: absolute; left:-1.5rem; top: 5px; height: 1.2em; width: 6px; background: var(--secondary-color); border-radius: 0 4px 4px 0;}
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* Bill Container */
        .bill-container { position: relative; width: 100%; aspect-ratio: 16 / 7; background-image: url('1000.png'); background-size: 100% 100%; background-position: center; background-repeat: no-repeat; border-radius: 8px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); padding: 0; overflow: hidden; border: 2px solid var(--secondary-color); box-sizing: border-box; }
        .bill-container canvas { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; display: block; z-index: 1; }
        
        /* SVG æŒ‡å¼•ç·šå±¤ */
        .bill-svg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .bill-arrow-line { stroke: var(--secondary-color); stroke-width: 3; fill: none; filter: drop-shadow(0px 1px 2px rgba(255,255,255,0.8)); transition: all 0.3s; }

        /* è³‡è¨Šçœ‹æ¿ */
        .bill-info-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 50px;
            border: 3px solid var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 10;
            pointer-events: none; 
            min-width: 220px;
            transition: all 0.3s ease;
        }
        .bill-info-text { font-size: 1.15rem; font-weight: 900; color: var(--secondary-color); margin: 0; line-height: 1.4; }

        /* Legend */
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; padding: 15px; background: rgba(8, 103, 136, 0.05); border-radius: 8px; border: 1px solid var(--border-color); }
        .legend-item { 
            display: flex; align-items: center; font-size: 0.9rem; color: var(--primary-color); 
            cursor: pointer; font-weight: 500; 
            padding: 6px 12px; border-radius: 20px; background: white; border: 1px solid #ddd;
            transition: all 0.2s;
            user-select: none;
        }
        .legend-item:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .legend-item.active { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); }
        .legend-item.active .legend-color-box { border-color: white; }

        /* Buttons & Search */
        .btn-group { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 1rem; }
        .big-btn { padding: 1.5rem; width: 220px; border: none; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s, filter 0.2s; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
        .big-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); filter: brightness(1.1); }
        .btn-a { background: linear-gradient(135deg, var(--secondary-color), #0a7ea6); color: white; }
        .btn-c { background: linear-gradient(135deg, var(--accent-color), #ffd500); color: var(--primary-color); }
        .search-wrapper { margin: 2rem 0; text-align: center; width: 100%; }
        .search-input-lg { width: 100%; max-width: 600px; padding: 15px 25px; font-size: 1.1rem; border: 3px solid var(--border-color); border-radius: 50px; outline: none; transition: 0.3s; background-color: var(--card-bg); color: var(--primary-color); }
        .search-input-lg:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 4px rgba(8, 103, 136, 0.15); }

        /* Project Block */
        .project-block { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, border-color 0.2s; display: grid; grid-template-columns: 1fr auto; gap: 15px; cursor: pointer; border: 2px solid var(--border-color); border-left: 8px solid var(--accent-color); }
        .project-block:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--secondary-color); }
        .pb-info { display:flex; flex-direction:column; justify-content:center; min-width: 0; }
        .pb-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin: 0 0 8px 0; word-break: break-word; }
        .pb-dept { background: var(--bg-color); color: var(--secondary-color); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; width: fit-content; border: 1px solid rgba(8, 103, 136, 0.3); }
        .pb-amount { font-size: 1.5rem; color: var(--secondary-color); font-weight: 900; white-space: nowrap; text-align: right; }

        /* Ranking */
        .ranking-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; }
        .rank-column h3 { border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; color: var(--primary-color); }
        .rank-group { margin-bottom: 30px; }
        .rank-group h4 { margin: 15px 0 10px; color: #555; font-size: 1.05rem; font-weight:bold; }
        .rank-list { list-style: none; padding: 0; }
        .rank-list li { padding: 12px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; color: var(--primary-color); font-weight: 500; }
        .rank-idx { background: var(--secondary-color); color: white; width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 50%; display:inline-block; margin-right:10px; font-weight: bold; box-shadow: 1px 1px 3px rgba(0,0,0,0.2);}
        .color-cut { color: var(--danger-color); font-weight:900; }
        .color-freeze { color: var(--accent-color); font-weight:900; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 900px; max-height: 90vh; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: slideUp 0.3s ease-out; position:relative; display: flex; flex-direction: column; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header-area { padding: 30px; border-bottom: 1px solid #eee; position: relative; background-color: #fff; }
        .close-btn { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; cursor: pointer; color: #aaa; line-height: 0.8; z-index: 10; transition:0.2s; }
        .close-btn:hover { color: var(--danger-color); }
        .modal-tabs { display: flex; background: var(--bg-color); border-bottom: 2px solid var(--border-color); }
        .modal-tab { flex: 1; text-align: center; padding: 18px; cursor: pointer; font-weight: bold; color: #777; border-bottom: 4px solid transparent; transition: 0.3s; font-size: 1.05rem;}
        .modal-tab:hover { background: rgba(8, 103, 136, 0.05); color: var(--secondary-color); }
        .modal-tab.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); background: white; }
        .modal-body-area { padding: 30px; overflow-y: auto; max-height: calc(90vh - 180px); scroll-behavior: auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .modal-charts-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-top: 25px; }
        .mini-chart-box { text-align: center; background: #fff; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .mini-chart-box h4 { margin-top: 0; color: var(--secondary-color); }
        .desc-container { position: relative; max-height: 100px; overflow: hidden; transition: max-height 0.3s ease; }
        .desc-container.expanded { max-height: none; }
        .desc-gradient { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1)); pointer-events: none; }
        .desc-container.expanded .desc-gradient { display: none; }
        .toggle-btn { display: block; width: 100%; text-align: center; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 2px solid var(--secondary-color); border-radius: 8px; cursor: pointer; color: var(--secondary-color); font-weight: bold; transition: 0.2s; }
        .toggle-btn:hover { background: var(--secondary-color); color: white; }

        /* Loader & Error */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(248, 248, 248, 0.95); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #e0e0e0; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { text-align:center; padding: 20px; color: #E74C3C; background: #ffeaea; border-radius: 10px; border: 1px solid #E74C3C; max-width: 80%; }
        .demo-mode-badge { background: var(--warning-color); color: var(--primary-color); padding: 8px 16px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }

        /* Legislator */
        .filter-wrapper { text-align: center; margin-bottom: 30px; }
        .filter-btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; }
        .filter-tag { border: 2px solid var(--secondary-color); background: white; color: var(--secondary-color); padding: 8px 20px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .filter-tag:hover { background: var(--highlight-color); border-color: var(--highlight-color); color: var(--secondary-color); transform: translateY(-2px); }
        .filter-tag.active { background: var(--secondary-color); color: white; border-color: var(--secondary-color); box-shadow: 0 4px 8px rgba(8, 103, 136, 0.3); }
        .legislator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; margin-top: 25px; }
        .leg-card { background: white; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 2px solid var(--border-color); }
        .leg-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .leg-avatar { width: 110px; height: 110px; border-radius: 50%; background-color: var(--bg-color); margin-bottom: 20px; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; overflow: hidden; background-position: center; position: relative; }
        .leg-name { font-size: 1.5rem; font-weight: 900; margin-bottom: 8px; color: var(--primary-color); }
        .leg-party-tag { padding: 5px 15px; border-radius: 20px; color: white; font-size: 0.9rem; font-weight: bold; margin-bottom: 25px; display: inline-block; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .tag-kmt { background-color: var(--party-kmt); }
        .tag-dpp { background-color: var(--party-dpp); }
        .tag-tpp { background-color: var(--party-tpp); }
        .tag-npp { background-color: var(--party-npp); }
        .tag-other { background-color: var(--party-other); }
        .leg-stats-box { display: flex; justify-content: space-between; width: 100%; border-top: 2px solid #f0f0f0; padding-top: 20px; }
        .stat-item { flex: 1; text-align: center; }
        .stat-item:not(:last-child) { border-right: 2px solid #f0f0f0; }
        .stat-val { display: block; font-size: 1.4rem; font-weight: 900; color: var(--primary-color); }
        .stat-label { font-size: 0.85rem; color: #777; font-weight: bold; }
        .leg-modal-body { padding: 35px; overflow-y: auto; max-height: 90vh; }
        .leg-detail-header { text-align: center; margin-bottom: 40px; }
        .leg-detail-avatar { width: 130px; height: 130px; border-radius: 50%; background-color: var(--bg-color); margin: 0 auto 15px; border: 5px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background-position: center; display: flex; align-items: center; justify-content: center; font-size: 4.5rem; position: relative; overflow: hidden; }
        .leg-detail-table-title { border-left: 8px solid var(--secondary-color); padding-left: 15px; margin: 40px 0 20px 0; color: var(--primary-color); font-size: 1.3rem; }
        .title-cut { border-color: var(--danger-color); }
        .title-freeze { border-color: var(--accent-color); }
        .clickable-link { color: var(--secondary-color); cursor: pointer; text-decoration: underline; font-weight: bold; transition: 0.2s; }
        .clickable-link:hover { color: white; background-color: var(--secondary-color); border-radius: 4px; padding: 2px 6px; text-decoration: none; }
        .proposal-table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 1rem; }
        .proposal-table th, .proposal-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .proposal-table th { background-color: rgba(8, 103, 136, 0.05); color: var(--secondary-color); font-weight: bold; border-bottom: 2px solid var(--secondary-color); }
        .p-tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-right: 5px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .p-cut { background: var(--danger-color); }
        .p-freeze { background: var(--accent-color); color: var(--primary-color); }
        .jump-btn { background: var(--secondary-color); color: white; border: none; padding: 8px 18px; border-radius: 25px; cursor: pointer; font-size: 0.95rem; margin-top: 10px; display: inline-flex; align-items: center; transition: 0.3s; font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .jump-btn:hover { transform: translateY(-2px); box-shadow: 3px 3px 8px rgba(0,0,0,0.3); background-color: #0a7ea6; }
        .jump-btn::after { content: ' â”'; margin-left: 5px; }

        @media (max-width: 768px) {
            main { padding: 1rem; }
            .btn-group { flex-direction: column; gap: 15px; }
            .big-btn { width: 100%; }
            .chart-container { height: 250px; }
            /* â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆæ’è¡Œæ¦œå–®æ¬„è¨­å®š â˜…â˜…â˜… */
            .ranking-container { grid-template-columns: 1fr; gap: 20px; }
            .modal-charts-grid { grid-template-columns: 1fr; }
            .search-input-lg { font-size: 16px; padding: 12px 20px; }
            .project-block { grid-template-columns: 1fr; gap: 10px; border-left-width: 6px; }
            .pb-amount { text-align: left; margin-left: 0; font-size: 1.3rem; }
            .legislator-grid { grid-template-columns: 1fr; }
            .leg-modal-body { padding: 20px; }
            .bill-container { padding: 5% 10%; border-width: 1px; }
            .modal-header-area { padding: 20px; }
            .modal-body-area { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:var(--primary-color); font-weight:bold;">è³‡æ–™è®€å–ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>
    
    <div id="error-display" class="loading-overlay" style="display:none;">
        <div class="error-message">
            <h3>âš ï¸ è³‡æ–™è®€å–å¤±æ•—</h3>
            <p>ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ã€‚è«‹ç¢ºèª Google è©¦ç®—è¡¨å·²ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ã€‚</p>
        </div>
    </div>

    <div id="unifiedModal" class="modal-overlay" onclick="closeModal(event, 'unifiedModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'unifiedModal')">&times;</span>
            <div class="modal-header-area">
                <h2 id="u-title" style="margin:0 0 10px 0; color:var(--primary-color); font-size:1.6rem;"></h2>
                <div>
                    <span id="u-dept" class="pb-dept"></span>
                    <span id="u-amount" style="font-weight:900; color:var(--secondary-color); margin-left:15px; font-size:1.3rem;"></span>
                </div>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('plan')">å·¥ä½œè¨ˆç•«å…§å®¹</div>
                <div class="modal-tab" onclick="switchTab('review')">å¯©æŸ¥åˆªæ¸›çµæœ</div>
            </div>
            <div class="modal-body-area">
                <div id="tab-content-plan" class="tab-content active">
                    <div style="background:var(--bg-color); padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid var(--border-color);">
                        <strong style="color:var(--secondary-color); font-size:1.1rem;">å…§å®¹ï¼š</strong>
                        <div id="u-desc-container" class="desc-container" style="margin-top:10px;">
                            <span id="u-desc" style="color:#333;"></span>
                            <div class="desc-gradient"></div>
                        </div>
                        <button id="toggle-desc-btn" class="toggle-btn" onclick="toggleDesc()">å±•é–‹é–±è®€å…¨æ–‡</button>
                    </div>
                    <div class="modal-charts-grid">
                        <div class="mini-chart-box"><h4>åˆ†æ”¯è¨ˆç•«</h4><div style="height:250px;"><canvas id="chartDetailBar"></canvas></div></div>
                        <div class="mini-chart-box"><h4>ç”¨é€”æ¯”ä¾‹</h4><div style="height:250px;"><canvas id="chartDetailPie"></canvas></div></div>
                    </div>
                </div>
                <div id="tab-content-review" class="tab-content">
                    <div id="review-data-container">
                        <div class="modal-charts-grid">
                            <div class="mini-chart-box"><h4>æœ€çµ‚å¯©æŸ¥çµæœæ¯”ä¾‹</h4><div style="height:250px;"><canvas id="chartBResult"></canvas></div></div>
                            <div class="mini-chart-box"><h4>ä¸‰éšæ®µåˆªå‡æ¯”è¼ƒ</h4><div style="height:250px;"><canvas id="chartBStages"></canvas></div></div>
                        </div>
                        <div style="margin-top: 35px;">
                            <h3 style="border-left: 8px solid var(--accent-color); padding-left: 15px; color:var(--primary-color);">å§”å“¡ææ¡ˆç´€éŒ„</h3>
                            <div style="overflow-x: auto;">
                                <table class="proposal-table">
                                    <thead><tr><th style="width:18%">ææ¡ˆå§”å“¡</th><th style="width:22%">é¡åˆ¥/é‡‘é¡</th><th>ææ¡ˆç†ç”±</th></tr></thead>
                                    <tbody id="proposal-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="review-no-data" style="display:none; text-align:center; padding: 3rem; color:#999; font-size:1.1rem;">
                        <p>æ­¤è¨ˆç•«å°šç„¡å¯©æŸ¥åˆªæ¸›è³‡æ–™ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModalC" class="modal-overlay" onclick="closeModal(event, 'detailModalC')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'detailModalC')">&times;</span>
            <div class="leg-modal-body">
                <div class="leg-detail-header">
                    <div id="mc-avatar" class="leg-detail-avatar"></div>
                    <h2 id="mc-name" style="color:var(--primary-color); margin-bottom:10px; font-size:1.8rem;"></h2>
                    <span id="mc-party" class="leg-party-tag"></span>
                </div>
                <h3 class="leg-detail-table-title title-cut">åˆªæ¸›æ¡ˆææ¡ˆç´€éŒ„</h3>
                <div style="overflow-x: auto;">
                    <table class="proposal-table">
                        <thead><tr><th style="width:32%">åˆªæ¸›é …ç›®</th><th style="width:20%">åˆªæ¸›é‡‘é¡/æ¯”ä¾‹</th><th>åˆªæ¸›ç†ç”±</th></tr></thead>
                        <tbody id="table-cut-c"></tbody>
                    </table>
                </div>
                <h3 class="leg-detail-table-title title-freeze">å‡çµæ¡ˆææ¡ˆç´€éŒ„</h3>
                <div style="overflow-x: auto;">
                    <table class="proposal-table">
                        <thead><tr><th style="width:32%">å‡çµé …ç›®</th><th style="width:20%">å‡çµé‡‘é¡/æ¯”ä¾‹</th><th>å‡çµç†ç”±</th></tr></thead>
                        <tbody id="table-freeze-c"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <header>
        <h1 onclick="showPage('home')">ä¸­å¤®æ”¿åºœç¸½é ç®—è§€æ¸¬ç«™</h1>
        <nav>
            <button id="nav-home" onclick="showPage('home')">é¦–é </button>
            <button id="nav-budget" onclick="showPage('page-budget')">é ç®—å¯©æŸ¥</button>
            <button id="nav-legislator" onclick="showPage('page-legislator')">ç«‹å§”æŠŠé—œ</button>
        </nav>
    </header>

    <main>
        <section id="home" class="page-section active">
            <div class="hero">
                <h2 style="text-align: center; margin-bottom: 2.5rem; color:var(--primary-color); font-size:2rem; font-weight:900;">æ¯ä¸€ç­†ç´ç¨…éŒ¢ï¼Œéƒ½å€¼å¾—è¢«çœ‹è¦‹</h2>
            </div>
            
            <div id="demo-badge-home" class="demo-mode-badge" style="text-align:center;">âš ï¸ ç›®å‰é¡¯ç¤ºç‚ºæ¸¬è©¦è³‡æ–™ (ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«)</div>

            <div class="card" style="padding-bottom: 2.5rem;">
                <h3>ç¸½é ç®—å¯©æŸ¥æ¯”ä¾‹æ¦‚æ³</h3>
                <div style="height: 100px; margin-bottom: 2rem;"><canvas id="chartStatusB"></canvas></div>
                <div style="text-align:center; font-size:0.95rem; color:#666; margin-bottom:2rem; font-weight:500;">èªªæ˜ï¼šæ­¤åœ–è¡¨åŒ…å«å„å·¥ä½œè¨ˆç•«åˆªæ¸›èˆ‡éƒ¨æœƒé€šæ¡ˆåˆªæ¸›ä¹‹ç¸½å’Œã€‚</div>
                
                <div class="btn-group" style="margin-top:0; border-top:2px solid #f0f0f0; padding-top:2rem;">
                    <button class="big-btn btn-a" onclick="showPage('page-budget')">é–‹å§‹æœå°‹<br>é ç®—èˆ‡å¯©æŸ¥å…§å®¹</button>
                    <button class="big-btn btn-c" onclick="showPage('page-legislator')">é–‹å§‹æœå°‹<br>ç«‹å§”æŠŠé—œç´€éŒ„</button>
                </div>
            </div>

            <div class="ranking-container">
                <div class="card rank-column">
                    <h3>éƒ¨æœƒæ©Ÿé—œ Top 5</h3>
                    <div class="rank-group"><h4>åˆªæ¸›é‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-dept-cut"></ul></div>
                    <div class="rank-group"><h4>å‡çµé‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-dept-freeze"></ul></div>
                </div>
                <div class="card rank-column">
                    <h3>å·¥ä½œè¨ˆç•« Top 5</h3>
                    <div class="rank-group"><h4>åˆªæ¸›é‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-plan-cut"></ul></div>
                    <div class="rank-group"><h4>å‡çµé‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-plan-freeze"></ul></div>
                </div>
            </div>

            <div class="card">
                <h3>æ­·å¹´æ­²å‡ºé ç®—æ¯”è¼ƒ</h3>
                <div class="chart-container"><canvas id="chartYearly"></canvas></div>
            </div>
            
            <div class="card">
                <h3>115 å¹´åº¦é ç®—åˆ†é…æ¦‚æ³</h3>
                <div class="bill-container">
                    <svg id="pointer-layer" class="bill-svg-layer">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#086788" />
                            </marker>
                        </defs>
                        <path id="dynamic-arrow" class="bill-arrow-line" marker-end="url(#arrowhead)"></path>
                    </svg>
                    
                    <div id="bill-info-overlay" class="bill-info-overlay">
                        <p class="bill-info-text">è«‹é»æ“Šä¸‹æ–¹åœ–ä¾‹<br>æŸ¥çœ‹æ•¸å€¼</p>
                    </div>
                    <canvas id="chartAllocation"></canvas>
                </div>
                <div id="chartAllocationLegend" class="chart-legend"></div>
            </div>
        </section>

        <section id="page-budget" class="page-section">
            <h2 class="section-title">é ç®—è¨ˆç•«èˆ‡å¯©æŸ¥çµæœæœå°‹</h2>
            <div id="demo-badge-budget" class="demo-mode-badge" style="text-align:center;">âš ï¸ æ¸¬è©¦è³‡æ–™æ¨¡å¼ï¼šåƒ…èƒ½æœå°‹ã€Œæ¸¬è©¦ã€æˆ–ã€Œåœ‹é˜²ã€</div>
            <div class="search-wrapper"><input type="text" class="search-input-lg" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: åœ‹é˜², æ½›è‰¦, å‡çµ...)" oninput="handleSearchBudget(this.value)"></div>
            <div id="results-container-budget"><p align="center" style="color:#999; padding:30px; font-size:1.1rem;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹...</p></div>
        </section>

        <section id="page-legislator" class="page-section">
            <h2 class="section-title">ç«‹å§”æŠŠé—œç´€éŒ„</h2>
            <div id="demo-badge-leg" class="demo-mode-badge" style="text-align:center;">âš ï¸ æ¸¬è©¦è³‡æ–™æ¨¡å¼</div>
            <div class="filter-wrapper">
                <span style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">ä¾é»¨ç±ç¯©é¸ï¼š</span>
                <div class="filter-btn-group">
                    <button class="filter-tag active" data-party="all" onclick="filterLegislators('all')">å…¨éƒ¨</button>
                    <button class="filter-tag" data-party="æ°‘é€²é»¨" onclick="filterLegislators('æ°‘é€²é»¨')">æ°‘é€²é»¨</button>
                    <button class="filter-tag" data-party="åœ‹æ°‘é»¨" onclick="filterLegislators('åœ‹æ°‘é»¨')">åœ‹æ°‘é»¨</button>
                    <button class="filter-tag" data-party="æ°‘çœ¾é»¨" onclick="filterLegislators('æ°‘çœ¾é»¨')">æ°‘çœ¾é»¨</button>
                    <button class="filter-tag" data-party="æ™‚ä»£åŠ›é‡" onclick="filterLegislators('æ™‚ä»£åŠ›é‡')">æ™‚ä»£åŠ›é‡</button>
                    <button class="filter-tag" data-party="ç„¡é»¨ç±" onclick="filterLegislators('ç„¡é»¨ç±')">ç„¡é»¨ç±</button>
                </div>
            </div>
            <div class="card">
                <p style="text-align:center; color:#777; font-weight:500; margin-bottom:20px;">é»æ“Šå§”å“¡å¡ç‰‡å¯æŸ¥çœ‹è©³ç´°ææ¡ˆå…§å®¹</p>
                <div class="legislator-grid" id="leg-container-c"></div>
            </div>
        </section>
    </main>

    <script>
        // â˜…â˜…â˜… è¨­å®šæª”æ¡ˆ ID (å·²è‡ªå‹•å¡«å…¥æ‚¨çš„ ID) â˜…â˜…â˜…
        const FILE_ID = '1Qft9FVm9XtT3SVzbgX1NSduPP0sBR3CdGqiUsm-Mmrs'; 

        // ä½¿ç”¨ Query API (ä¸é€é GASï¼Œæ›´ç©©å®š)
        const getQueryUrl = (gid) => `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:json&tq&gid=${gid}&_=${new Date().getTime()}`;

        const dataSources = {
            'page-a': getQueryUrl('612819456'), 
            'page-b': getQueryUrl('1304436957'), 
            'page-c': getQueryUrl('1025885437') 
        };

        // Mock Data
        const MOCK_DATA_A=[{'è¨ˆç•«ç·¨è™Ÿ':'TEST001','è¨ˆç•«åç¨±':'åœ‹é˜²è‡ªä¸»å¼·åŒ–è¨ˆç•« (æ¸¬è©¦è³‡æ–™)','ä¸»ç®¡æ©Ÿé—œ':'åœ‹é˜²éƒ¨','é ç®—é‡‘é¡':'5000000000','å·¥ä½œå…§å®¹':'é€™æ˜¯æ¸¬è©¦ç”¨çš„è¨ˆç•«èªªæ˜ã€‚','åˆ†æ”¯è¨ˆç•«':'æ½›è‰¦åœ‹é€ :3000000000|ç„¡äººæ©Ÿç ”ç™¼:2000000000','ç”¨é€”æ¯”ä¾‹':'è£å‚™æ¡è³¼:70|ç ”ç™¼:30'}];
        const MOCK_DATA_B=[{'è¨ˆç•«ç·¨è™Ÿ':'TEST001','è¨ˆç•«åç¨±':'åœ‹é˜²è‡ªä¸»å¼·åŒ–è¨ˆç•« (æ¸¬è©¦è³‡æ–™)','ä¸»ç®¡æ©Ÿé—œ':'åœ‹é˜²éƒ¨','é ç®—é‡‘é¡':'5000000000','åˆªæ¸›é‡‘é¡':'1000000','å‡çµé‡‘é¡':'50000000','å§”å“¡æœƒåˆªæ¸›':'500000','å§”å“¡æœƒå‡çµ':'20000000','å”å•†åˆªæ¸›':'500000','å”å•†å‡çµ':'30000000','ææ¡ˆç´€éŒ„':'ç‹å°æ˜:å‡çµ:ç†ç”±A|æå°è¯:åˆªæ¸›:ç†ç”±B','è³‡æ–™é¡å‹':'è¨ˆç•«'}];
        const MOCK_DATA_C=[{'å§”å“¡å§“å':'ç‹å°æ˜ (æ¸¬è©¦)','é»¨ç±':'ç„¡é»¨ç±','åˆªæ¸›æ¡ˆæ•¸':'5','å‡çµæ¡ˆæ•¸':'10','ä¸»æ±ºè­°æ•¸':'2','ç…§ç‰‡':'','ææ¡ˆæ˜ç´°':'åˆªæ¸›#åœ‹é˜²è‡ªä¸»å¼·åŒ–è¨ˆç•« (æ¸¬è©¦è³‡æ–™)#100è¬#ç†ç”±B#TEST001'}];
        
        let allDataPageA = [], allDataPageB = [], allDataPageB_Plans = [], allDataPageC = []; 
        let mainChartsRendered = false;
        let isDemoMode = false;
        let chartStatusInstance = null;
        let chartAllocationInstance = null; // â˜…â˜…â˜… å…¨åŸŸè®Šæ•¸ï¼šç´™éˆ”åœ–è¡¨å¯¦ä¾‹

        // â˜…â˜…â˜… å…¨åŸŸå‡½å¼å®šç¾©å€ â˜…â˜…â˜…

        function parseMoney(str) {
            if(!str) return 0;
            let s = str + '';
            let val = parseFloat(s.replace(/,/g, '').replace(/[^0-9.-]/g, ''));
            if (isNaN(val)) return 0;
            if (s.includes('å„„')) return val * 100000000;
            else if (s.includes('è¬')) return val * 10000;
            else return val * 1000;
        }
        function formatCurrency(num) {
            let val = parseFloat(num);
            if (isNaN(val) || val === 0) return "0";
            let absVal = Math.abs(val);
            if (absVal >= 1000000000000) return (val / 1000000000000).toFixed(1).replace(/\.0$/, '') + "å…†";
            else if (absVal >= 100000000) return (val / 100000000).toFixed(1).replace(/\.0$/, '') + "å„„";
            else if (absVal >= 10000) return (val / 10000).toFixed(1).replace(/\.0$/, '') + "è¬";
            else return val.toLocaleString() + "å…ƒ";
        }
        const tooltipCurrencyCallback = {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    let value = context.raw;
                    if (value !== null && value !== undefined) { label += formatCurrency(value); }
                    return label;
                }
            }
        };

        function renderRankList(elementId,list,type){const el=document.getElementById(elementId);if(!list||list.length===0){el.innerHTML='<li style="color:#999;">ç„¡è³‡æ–™</li>';return}let html='';list.forEach((item,index)=>{let val=type==='cut'?item.cut:item.freeze;let valDisplay=formatCurrency(val);let colorClass=type==='cut'?'color-cut':'color-freeze';html+=`<li><span><span class="rank-idx">${index+1}</span> ${item.name}</span><span class="rank-val ${colorClass}">${valDisplay}</span></li>`});el.innerHTML=html}

        function displayUnifiedBlocks(data){
            const container=document.getElementById('results-container-budget');
            if(!data||data.length===0){
                container.innerHTML='<p align="center" style="color:#999; padding:30px; font-size:1.1rem;">æŸ¥ç„¡è³‡æ–™</p>';
                return;
            }
            let html='';
            data.forEach(row=>{
                const id = row['è¨ˆç•«ç·¨è™Ÿ'];
                const amountRaw=parseMoney(row['é ç®—é‡‘é¡']);
                html+=`<div class="project-block" onclick="openUnifiedDetail('${id}')">
                    <div class="pb-info">
                        <h3 class="pb-title">${row['è¨ˆç•«åç¨±']}</h3>
                        <span class="pb-dept">${row['ä¸»ç®¡æ©Ÿé—œ']}</span>
                    </div>
                    <div class="pb-amount">${formatCurrency(amountRaw)}</div>
                </div>`;
            });
            container.innerHTML=html;
        }

        function handleSearchBudget(val) {
            const container = document.getElementById('results-container-budget');
            if (!val.trim()) { 
                container.innerHTML = '<p align="center" style="color:#999; padding:30px; font-size:1.1rem;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹...</p>'; 
                return; 
            }
            const keywords = val.toLowerCase().replace(/\s+and\s+/g, ' ').split(/\s+/).filter(k => k.trim() !== '');
            const filtered = allDataPageA.filter(r => {
                const content = ((r['è¨ˆç•«åç¨±'] || '') + (r['å·¥ä½œå…§å®¹'] || '') + (r['ä¸»ç®¡æ©Ÿé—œ'] || '')).toLowerCase();
                return keywords.every(k => content.includes(k));
            });
            displayUnifiedBlocks(filtered);
        }

        function processPageBData(data){
            let totalCut=0,totalFreeze=0,totalBudget=0;let deptStats={};allDataPageB_Plans=[];
            data.forEach(row=>{
                const amount=parseMoney(row['é ç®—é‡‘é¡']);const cut=parseMoney(row['åˆªæ¸›é‡‘é¡']);const freeze=parseMoney(row['å‡çµé‡‘é¡']);const dept=row['ä¸»ç®¡æ©Ÿé—œ']||'å…¶ä»–';const type=row['è³‡æ–™é¡å‹']||'è¨ˆç•«';
                totalBudget+=amount;totalCut+=cut;totalFreeze+=freeze;
                if(!deptStats[dept])deptStats[dept]={name:dept,cut:0,freeze:0};deptStats[dept].cut+=cut;deptStats[dept].freeze+=freeze;
                if(type==='è¨ˆç•«'){allDataPageB_Plans.push(row)}
            });
            const totalPass=totalBudget-totalCut-totalFreeze;
            const ctxStatus = document.getElementById('chartStatusB');
            
            if (ctxStatus) {
                if (chartStatusInstance) {
                    chartStatusInstance.destroy();
                }
                chartStatusInstance = new Chart(ctxStatus.getContext('2d'),{type:'bar',data:{labels:['ç¸½é«”å¯©æŸ¥çµæœ'],datasets:[{label:'é€šé',data:[totalPass],backgroundColor:'#086788',barThickness:40},{label:'å‡çµ',data:[totalFreeze],backgroundColor:'#F0C808',barThickness:40},{label:'åˆªæ¸›',data:[totalCut],backgroundColor:'#E74C3C',barThickness:40}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,display:false},y:{stacked:true,display:false}},plugins:{legend:{position:'top'},tooltip:tooltipCurrencyCallback}}});
            }
            const deptArray=Object.values(deptStats);renderRankList('rank-dept-cut',[...deptArray].sort((a,b)=>b.cut-a.cut).slice(0,5),'cut');renderRankList('rank-dept-freeze',[...deptArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5),'freeze');
            const planArray=allDataPageB_Plans.map(r=>({name:r['è¨ˆç•«åç¨±'],cut:parseMoney(r['åˆªæ¸›é‡‘é¡']),freeze:parseMoney(r['å‡çµé‡‘é¡'])})).filter(r=>r.name);renderRankList('rank-plan-cut',[...planArray].sort((a,b)=>b.cut-a.cut).slice(0,5),'cut');renderRankList('rank-plan-freeze',[...planArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5),'freeze');
        }

        function renderLegislatorGrid(data) {
            const container = document.getElementById('leg-container-c');
            if(!data || data.length === 0) { container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">ç„¡è³‡æ–™</p>'; return; }
            
            let html = '';
            data.forEach(row => {
                const name = row['å§”å“¡å§“å'] || 'æœªçŸ¥å§”å“¡';
                const party = row['é»¨ç±'] || 'ç„¡é»¨ç±';
                const photoPath = `./photos/${name}.jpg`;

                let partyClass = 'tag-other';
                if(party.includes('æ°‘é€²')) partyClass='tag-dpp';
                else if(party.includes('åœ‹æ°‘')) partyClass='tag-kmt';
                else if(party.includes('æ°‘çœ¾')) partyClass='tag-tpp';
                else if(party.includes('æ™‚ä»£')) partyClass='tag-npp';

                const rowStr = encodeURIComponent(JSON.stringify(row));
                
                // â˜…â˜…â˜… object-position: center 25% å·²å¥—ç”¨ â˜…â˜…â˜…
                html += `
                <div class="leg-card" onclick="openDetailC('${rowStr}')">
                    <div class="leg-avatar" id="avatar-${name}" style="position:relative; overflow:hidden;">
                        <span class="default-icon" style="z-index:1;">ğŸ§‘â€ğŸ’¼</span>
                        <img src="${photoPath}" 
                             style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; object-position: center 25%; display:none;" 
                             onload="this.style.display='block'; this.previousElementSibling.style.display='none';"
                             onerror="this.style.display='none';">
                    </div>
                    <div class="leg-name">${name}</div>
                    <span class="leg-party-tag ${partyClass}">${party}</span>
                    <div class="leg-stats-box">
                        <div class="stat-item"><span class="stat-val" style="color:var(--danger-color);">${row['åˆªæ¸›æ¡ˆæ•¸']||0}</span><span class="stat-label">åˆªæ¸›æ¡ˆ</span></div>
                        <div class="stat-item"><span class="stat-val" style="color:var(--warning-color);">${row['å‡çµæ¡ˆæ•¸']||0}</span><span class="stat-label">å‡çµæ¡ˆ</span></div>
                        <div class="stat-item"><span class="stat-val" style="color:var(--secondary-color);">${row['ä¸»æ±ºè­°æ•¸']||0}</span><span class="stat-label">ä¸»æ±ºè­°</span></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šè£œå› renderProposalTable å‡½å¼ â˜…â˜…â˜…
        function renderProposalTable(row){
            const tbody=document.getElementById('proposal-table-body');
            tbody.innerHTML='';
            const proposalStr=row['ææ¡ˆç´€éŒ„']||'';
            if(!proposalStr){tbody.innerHTML='<tr><td colspan="3" style="text-align:center">æš«ç„¡è©³ç´°ææ¡ˆè³‡æ–™</td></tr>';return}
            proposalStr.split('|').forEach(p=>{
                const parts=p.split(':');
                if(parts.length>=3){
                    const typeClass=parts[1].includes('åˆª')?'p-cut':'p-freeze';
                    const legName=parts[0].trim();
                    const nameHtml=`<span class="clickable-link" onclick="jumpToC('${legName}')">${legName}</span>`;
                    tbody.innerHTML+=`<tr><td><strong>${nameHtml}</strong></td><td><span class="p-tag ${typeClass}">${parts[1]}</span></td><td>${parts[2]}</td></tr>`
                }
            })
        }

        function renderLegislatorTables(detailStr) {
            const tableCut = document.getElementById('table-cut-c');
            const tableFreeze = document.getElementById('table-freeze-c');
            tableCut.innerHTML = ''; tableFreeze.innerHTML = '';
            if(!detailStr) {
                const emptyRow = '<tr><td colspan="3" style="text-align:center; color:#999;">ç„¡è©³ç´°è³‡æ–™</td></tr>';
                tableCut.innerHTML = emptyRow; tableFreeze.innerHTML = emptyRow; return;
            }
            const items = detailStr.split('|');
            let hasCut = false, hasFreeze = false;
            items.forEach(item => {
                const parts = item.split('#');
                if(parts.length >= 4) {
                    const type = parts[0].trim();
                    const projectId = parts[4] ? parts[4].trim() : '';
                    let nameHtml = parts[1].trim();
                    if(projectId) {
                        nameHtml = `<span class="clickable-link" onclick="jumpToProjectB('${projectId}')">${nameHtml}</span>`;
                    }
                    const rowHtml = `<tr><td>${nameHtml}</td><td>${parts[2].trim()}</td><td>${parts[3].trim()}</td></tr>`;
                    if(type.includes('åˆª')) { tableCut.innerHTML += rowHtml; hasCut = true; } 
                    else if(type.includes('å‡')) { tableFreeze.innerHTML += rowHtml; hasFreeze = true; }
                }
            });
            if(!hasCut) tableCut.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">ç„¡åˆªæ¸›ææ¡ˆ</td></tr>';
            if(!hasFreeze) tableFreeze.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">ç„¡å‡çµææ¡ˆ</td></tr>';
        }

        function openDetailC(str) {
            const row = JSON.parse(decodeURIComponent(str));
            const modal = document.getElementById('detailModalC');
            const name = row['å§”å“¡å§“å'];
            
            document.getElementById('mc-name').innerText = name;
            document.getElementById('mc-party').innerText = row['é»¨ç±'];
            
            let partyClass = 'tag-other';
            const party = row['é»¨ç±'] || '';
            if(party.includes('æ°‘é€²')) partyClass='tag-dpp';
            else if(party.includes('åœ‹æ°‘')) partyClass='tag-kmt';
            else if(party.includes('æ°‘çœ¾')) partyClass='tag-tpp';
            else if(party.includes('æ™‚ä»£')) partyClass='tag-npp';
            document.getElementById('mc-party').className = `leg-party-tag ${partyClass}`;
            
            const photoPath = `./photos/${name}.jpg`;
            const avatarDiv = document.getElementById('mc-avatar');
            
            // â˜…â˜…â˜… object-position: center 25% å·²å¥—ç”¨ â˜…â˜…â˜…
            avatarDiv.innerHTML = `
                <span class="default-icon" style="z-index:1;">ğŸ§‘â€ğŸ’¼</span>
                <img src="${photoPath}" 
                     style="width:100%; height:100%; object-fit:cover; object-position: center 25%; display:none; border-radius:50%;" 
                     onload="this.style.display='block'; this.previousElementSibling.style.display='none';"
                     onerror="this.style.display='none';">
            `;
            avatarDiv.style.backgroundImage = 'none';
            avatarDiv.style.overflow = 'hidden'; 
            avatarDiv.style.position = 'relative';

            setTimeout(() => {
                const legBody = document.querySelector('#detailModalC .leg-modal-body');
                if (legBody) legBody.scrollTop = 0;
            }, 0);
            
            renderLegislatorTables(row['ææ¡ˆæ˜ç´°'] || '');
            modal.style.display = 'flex';
        }

        // â˜…â˜…â˜… æ›´æ–°å¾Œçš„ renderMainCharts (äº’å‹•åœ–ä¾‹ + SVG æŒ‡å¼•ç·š) â˜…â˜…â˜…
        function renderMainCharts(){
            if(mainChartsRendered) return;
            
            new Chart(document.getElementById('chartYearly').getContext('2d'),{
                type:'bar',
                data:{
                    labels:['115å¹´åº¦','114å¹´åº¦','113å¹´åº¦','112å¹´åº¦','111å¹´åº¦','110å¹´åº¦','109å¹´åº¦','108å¹´åº¦','107å¹´åº¦','106å¹´åº¦'],
                    datasets:[{
                        label:'æ­²å‡ºç¸½é¡',
                        data:[3034974371000,3132468909000,2881782095000,2719098790000,2262064189000,2161517070000,2102196982000,2022029637000,1991773071000,1997995520000],
                        backgroundColor:'#086788'
                    }]
                },
                options:{
                    responsive:true, maintainAspectRatio:false,
                    plugins:{ tooltip: tooltipCurrencyCallback },
                    scales: { y: { ticks: { callback: function(value) { return formatCurrency(value); } } } }
                }
            });

            // é ç®—è©³ç´°è³‡æ–™ (ç”¨æ–¼é»æ“Šåœ–ä¾‹å¾Œçš„é¡¯ç¤º)
            const budgetDetails = [
                { label:'ç¤¾æœƒç¦åˆ©', value:831800000000, color:'rgba(231, 76, 60, 0.5)', arrow:'â–²', display:'8318å„„' },
                { label:'æ•™è‚²ç§‘å­¸æ–‡åŒ–', value:556600000000, color:'rgba(240, 200, 8, 0.5)', arrow:'â–¼', display:'5566å„„' },
                { label:'åœ‹é˜²', value:548800000000, color:'rgba(8, 103, 136, 0.5)', arrow:'â–²', display:'5488å„„' },
                { label:'ç¶“æ¿Ÿç™¼å±•', value:427500000000, color:'rgba(46, 204, 113, 0.5)', arrow:'â–²', display:'4275å„„' },
                { label:'ä¸€èˆ¬æ”¿å‹™', value:302600000000, color:'rgba(155, 89, 182, 0.5)', arrow:'â–²', display:'3026å„„' },
                { label:'é€€ä¼‘æ’«å¹', value:184400000000, color:'rgba(52, 152, 219, 0.5)', arrow:'â–²', display:'1844å„„' },
                { label:'å‚µå‹™é‚„æœ¬ä»˜æ¯', value:106300000000, color:'rgba(230, 126, 34, 0.5)', arrow:'â€“', display:'1063å„„' },
                { label:'è£œåŠ©åŠå…¶ä»–', value:50400000000, color:'rgba(26, 188, 156, 0.5)', arrow:'â–¼', display:'504å„„' },
                { label:'ç¤¾å€ç™¼å±•åŠç’°å¢ƒä¿è­·', value:26600000000, color:'rgba(52, 73, 94, 0.5)', arrow:'â–¼', display:'266å„„' }
            ];

            const ctx = document.getElementById('chartAllocation').getContext('2d');
            const totalBudget = budgetDetails.reduce((acc, curr) => acc + curr.value, 0);

            // Chart Config - é—œé–‰ Tooltipï¼Œæ”¹ç”¨å¤–éƒ¨æ§åˆ¶
            chartAllocationInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['115å¹´åº¦é ç®—çµæ§‹'],
                    datasets: budgetDetails.map(d => ({
                        label: d.label,
                        data: [d.value],
                        backgroundColor: d.color,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }))
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { stacked: true, display: false, min: 0, max: totalBudget },
                        y: { stacked: true, display: false }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: false } // é—œé–‰é è¨­ Tooltip
                    },
                    layout: { padding: 0 }
                }
            });
            
            // ç”¢ç”Ÿäº’å‹•å¼åœ–ä¾‹
            const legendContainer = document.getElementById('chartAllocationLegend');
            const infoOverlay = document.getElementById('bill-info-overlay');
            const arrowLine = document.getElementById('dynamic-arrow');
            
            if(legendContainer) {
                let legendHtml = '';
                budgetDetails.forEach((ds, index) => {
                    let color = ds.color.replace('0.5', '1'); 
                    legendHtml += `
                        <div class="legend-item" onclick="updateBillOverlay(${index}, '${ds.label}', '${ds.display}', '${ds.arrow}')">
                            <div class="legend-color-box" style="background-color:${color}; border:none;"></div>
                            <span>${ds.label}</span>
                        </div>
                    `;
                });
                legendContainer.innerHTML = legendHtml;
            }

            // å®šç¾©æ›´æ–° overlay çš„å‡½å¼
            window.updateBillOverlay = function(index, label, display, arrow) {
                // æ›´æ–°æ–‡å­—
                infoOverlay.innerHTML = `
                    <p class="bill-info-text">${label} ${display} (${arrow})</p>
                `;
                
                // æ›´æ–°åœ–ä¾‹ Active ç‹€æ…‹
                document.querySelectorAll('.legend-item').forEach((el, i) => {
                    if (i === index) el.classList.add('active');
                    else el.classList.remove('active');
                });

                // â˜…â˜…â˜… ç¹ªè£½æŒ‡å¼•ç·š â˜…â˜…â˜…
                if (!chartAllocationInstance) return;
                
                // 1. åŒæ­¥ SVG åº§æ¨™ç³»èˆ‡ Chart å…§éƒ¨åº§æ¨™ç³» (é€™æ­¥æœ€é—œéµï¼Œè§£æ±ºæ‰‹æ©Ÿè§£æåº¦å•é¡Œ)
                const chart = chartAllocationInstance;
                const svg = document.getElementById('pointer-layer');
                svg.setAttribute('viewBox', `0 0 ${chart.width} ${chart.height}`);
                
                // 2. å–å¾—ç›®æ¨™ Bar çš„åº§æ¨™
                const meta = chart.getDatasetMeta(index);
                const bar = meta.data[0]; 
                
                if (bar) {
                    const targetX = (bar.x + bar.base) / 2;
                    const targetY = bar.y - (bar.height / 2); // Bar çš„é ‚ç«¯

                    // 3. å–å¾— Info Box çš„åº§æ¨™ (DOM åº§æ¨™ -> è½‰æ›ç‚º Chart å…§éƒ¨åº§æ¨™)
                    const containerRect = document.querySelector('.bill-container').getBoundingClientRect();
                    const infoBoxRect = document.getElementById('bill-info-overlay').getBoundingClientRect();
                    
                    // è¨ˆç®—ç›¸å°ä½ç½® (DOM åƒç´ )
                    const boxLeftRel = infoBoxRect.left - containerRect.left;
                    const boxTopRel = infoBoxRect.top - containerRect.top;
                    
                    // è¨ˆç®—æ¯”ä¾‹å°º (Chart å…§éƒ¨åƒç´  / DOM é¡¯ç¤ºåƒç´ )
                    const scaleX = chart.width / containerRect.width;
                    const scaleY = chart.height / containerRect.height;
                    
                    // è½‰æ› Info Box åº§æ¨™åˆ° Chart åº§æ¨™ç³»
                    const startX = (boxLeftRel + (infoBoxRect.width / 2)) * scaleX;
                    const startY = (boxTopRel + infoBoxRect.height) * scaleY; // å¾ Box åº•éƒ¨å‡ºç™¼

                    // 4. ç•«ç·š (SVG Path)
                    const pathData = `M ${startX} ${startY} L ${targetX} ${targetY}`;
                    arrowLine.setAttribute('d', pathData);
                    arrowLine.style.opacity = '1';
                }
            };
            
            mainChartsRendered=true;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
            document.querySelectorAll('header nav button').forEach(b => b.classList.remove('nav-active'));
            if(pageId === 'home') document.getElementById('nav-home').classList.add('nav-active');
            if(pageId === 'page-budget') document.getElementById('nav-budget').classList.add('nav-active');
            if(pageId === 'page-legislator') document.getElementById('nav-legislator').classList.add('nav-active');
            if (pageId === 'page-legislator' && allDataPageC.length === 0 && !isDemoMode) fetchData('page-c');
        }

        function toggleDesc() {
            const container = document.getElementById('u-desc-container');
            const btn = document.getElementById('toggle-desc-btn');
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                btn.innerText = 'å±•é–‹é–±è®€å…¨æ–‡';
            } else {
                container.classList.add('expanded');
                btn.innerText = 'æ”¶åˆå…§å®¹';
            }
        }

        // ç›£è½å™¨
        window.addEventListener('DOMContentLoaded', () => {
            renderMainCharts();
            Promise.all([
                fetchData('page-a', true),
                fetchData('page-b', true),
                fetchData('page-c', true)
            ]).then(() => {
                if(isDemoMode) {
                    document.querySelectorAll('.demo-mode-badge').forEach(el => el.style.display = 'block');
                }
            });
        });

        // ç›£è½è¦–çª—å¤§å°æ”¹è®Šï¼Œé‡ç½®æŒ‡å¼•ç·š
        window.addEventListener('resize', () => {
            const arrowLine = document.getElementById('dynamic-arrow');
            if(arrowLine) arrowLine.style.opacity = '0';
        });

        function parseQueryResponse(jsonData) {
            const table = jsonData.table;
            const cols = table.cols.map(c => c.label).filter(l => l !== '');
            const rows = table.rows;
            
            return rows.map(row => {
                let obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) {
                        obj[cols[i]] = cell ? (cell.v !== null ? String(cell.v) : '') : '';
                    }
                });
                return obj;
            });
        }

        async function fetchData(pageId, silent = false) {
            const loader = document.getElementById('loader');
            const errorDisplay = document.getElementById('error-display');
            
            let targetUrl = dataSources[pageId];
            if(pageId === 'page-budget') return []; 
            if(pageId === 'page-legislator') targetUrl = dataSources['page-c'];

            if (!silent) loader.style.display = 'flex';

            try {
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                
                if (text.includes('<!DOCTYPE html>') || text.includes('google.com/accounts')) {
                    throw new Error("Login Page Detected (Permissions Error)");
                }

                const jsonText = text.substring(47, text.length - 2);
                const jsonData = JSON.parse(jsonText);
                
                if (jsonData.status === 'error') {
                    throw new Error("Google Query API Error: " + JSON.stringify(jsonData.errors));
                }

                let cleanData = parseQueryResponse(jsonData);

                if (pageId === 'page-a') { allDataPageA = cleanData; } 
                else if (pageId === 'page-b') { allDataPageB = cleanData; processPageBData(allDataPageB); } 
                else if (pageId === 'page-c') { allDataPageC = cleanData; filterLegislators('all'); }

                if (!silent) loader.style.display = 'none';
                return cleanData;

            } catch (error) {
                console.warn(`[${pageId}] Fetch failed, using Mock Data.`, error);
                
                isDemoMode = true; 
                let mockData = [];
                if (pageId === 'page-a') { mockData = MOCK_DATA_A; allDataPageA = mockData; }
                else if (pageId === 'page-b') { mockData = MOCK_DATA_B; allDataPageB = mockData; processPageBData(mockData); }
                else if (pageId === 'page-c') { mockData = MOCK_DATA_C; allDataPageC = mockData; filterLegislators('all'); }
                
                if (!silent) {
                    loader.style.display = 'none';
                    if(errorDisplay) {
                        errorDisplay.style.display = 'flex';
                        if (error.message.includes("Login Page")) {
                            errorDisplay.innerHTML = `<div class="error-message"><h3>âš ï¸ æ¬Šé™éŒ¯èª¤</h3><p>Google è©¦ç®—è¡¨è¦æ±‚ç™»å…¥ã€‚</p><p>è«‹å‹™å¿…å°‡è©¦ç®—è¡¨å…±ç”¨æ¬Šé™è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äºº (æª¢è¦–è€…)ã€</p><p>ä¸¦ç¢ºèª FILE_ID æ­£ç¢ºã€‚</p></div>`;
                        } else if (error.message.includes("404")) {
                            errorDisplay.innerHTML = `<div class="error-message"><h3>âš ï¸ æ‰¾ä¸åˆ°æª”æ¡ˆ</h3><p>è«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ FILE_ID æ˜¯å¦æ­£ç¢ºã€‚<br>(ä¸æ˜¯ 2PACX é–‹é ­çš„é‚£å€‹)</p></div>`;
                        }
                    }
                    document.querySelectorAll('.demo-mode-badge').forEach(el => el.style.display = 'block');
                }
                return mockData;
            }
        }

        function filterLegislators(party) {
            document.querySelectorAll('.filter-tag').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.party === party) btn.classList.add('active');
            });
            let filtered = [];
            if (party === 'all') { filtered = allDataPageC; } 
            else { filtered = allDataPageC.filter(r => (r['é»¨ç±'] || '').includes(party)); }
            renderLegislatorGrid(filtered);
        }

        let chartBarA = null, chartPieA = null, chartB1 = null, chartB2 = null;
        function openUnifiedDetail(id) {
            const planData = allDataPageA.find(r => r['è¨ˆç•«ç·¨è™Ÿ'] === id);
            const reviewData = allDataPageB.find(r => r['è¨ˆç•«ç·¨è™Ÿ'] === id);
            if (!planData && !reviewData) { alert("è³‡æ–™è®€å–éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²è¨ˆç•« (è«‹æª¢æŸ¥è¨ˆç•«ç·¨è™Ÿæ˜¯å¦æ­£ç¢º)"); return; }
            const baseData = planData || reviewData; 
            document.getElementById('u-title').innerText = baseData['è¨ˆç•«åç¨±'];
            document.getElementById('u-dept').innerText = baseData['ä¸»ç®¡æ©Ÿé—œ'];
            document.getElementById('u-amount').innerText = formatCurrency(parseMoney(baseData['é ç®—é‡‘é¡']));
            
            if (planData) {
                document.getElementById('u-desc').innerText = planData['å·¥ä½œå…§å®¹'] || 'ç„¡';
                document.getElementById('u-desc-container').classList.remove('expanded');
                document.getElementById('toggle-desc-btn').innerText = 'å±•é–‹é–±è®€å…¨æ–‡';
                if(chartBarA) chartBarA.destroy(); if(chartPieA) chartPieA.destroy();
                renderDetailChartsA(planData);
            } else { document.getElementById('u-desc').innerText = 'æ­¤è¨ˆç•«ç„¡è©³ç´°ç·¨åˆ—å…§å®¹è³‡æ–™ã€‚'; }
            
            const reviewContainer = document.getElementById('review-data-container');
            const reviewNoData = document.getElementById('review-no-data');
            if (reviewData) {
                reviewContainer.style.display = 'block'; reviewNoData.style.display = 'none';
                if(chartB1) chartB1.destroy(); if(chartB2) chartB2.destroy();
                renderDetailChartsB(reviewData); 
                renderProposalTable(reviewData);
            } else { reviewContainer.style.display = 'none'; reviewNoData.style.display = 'block'; }
            
            setTimeout(() => {
                const modalBody = document.querySelector('#unifiedModal .modal-body-area');
                if (modalBody) modalBody.scrollTop = 0;
            }, 0);

            switchTab('plan'); document.getElementById('unifiedModal').style.display = 'flex';
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tabName === 'plan') {
                document.querySelector('.modal-tab:first-child').classList.add('active');
                document.getElementById('tab-content-plan').classList.add('active');
            } else {
                document.querySelector('.modal-tab:last-child').classList.add('active');
                document.getElementById('tab-content-review').classList.add('active');
            }
            setTimeout(() => {
                const modalBody = document.querySelector('#unifiedModal .modal-body-area');
                if (modalBody) modalBody.scrollTop = 0;
            }, 0);
        }

        async function jumpToProjectB(projectId) {
            const loader = document.getElementById('loader'); loader.style.display = 'flex';
            closeModal(null, 'detailModalC'); showPage('page-budget');
            if(allDataPageA.length === 0) await fetchData('page-a', true);
            if(allDataPageB.length === 0) await fetchData('page-b', true);
            const targetId = String(projectId).trim(); openUnifiedDetail(targetId); switchTab('review');
            loader.style.display = 'none';
        }

        async function jumpToC(name) {
            const loader = document.getElementById('loader'); loader.style.display = 'flex';
            closeModal(null, 'unifiedModal'); 
            if(allDataPageC.length === 0) { try { await fetchData('page-c'); } catch(e) { loader.style.display = 'none'; return; } }
            const targetName = String(name).trim();
            const target = allDataPageC.find(r => String(r['å§”å“¡å§“å']).trim() === targetName);
            loader.style.display = 'none';
            if(target) { const str = encodeURIComponent(JSON.stringify(target)); openDetailC(str); } 
            else { alert(`æŸ¥ç„¡æ­¤å§”å“¡è³‡æ–™ (${targetName})`); }
        }

        function closeModal(e,modalId){if(e&&e.target!==e.currentTarget&&e.target.className!=='close-btn')return;document.getElementById(modalId).style.display='none'}

        function renderDetailChartsA(row){
            let subLabels=[],subData=[];
            let branchString=row['åˆ†æ”¯è¨ˆç•«']||'';
            if(branchString&&branchString.includes(':')){
                branchString.split('|').forEach(item=>{
                    let parts=item.split(':');
                    if(parts.length===2){subLabels.push(parts[0].trim());subData.push(parseMoney(parts[1].trim()))}
                })
            }
            let pieLabels=[],pieData=[];
            let usageString=row['ç”¨é€”æ¯”ä¾‹']||'';
            if(usageString&&usageString.includes(':')){
                usageString.split('|').forEach(item=>{
                    let parts=item.split(':');
                    if(parts.length===2){pieLabels.push(parts[0].trim());pieData.push(parseInt(parts[1].trim()))}
                })
            }
            const ctxBar=document.getElementById('chartDetailBar').getContext('2d');
            chartBarA=new Chart(ctxBar,{type:'bar',data:{labels:subLabels,datasets:[{label:'é‡‘é¡',data:subData,backgroundColor:'#086788',borderRadius:4}]},options:{indexAxis:'y',maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tooltipCurrencyCallback}}});
            const ctxPie=document.getElementById('chartDetailPie').getContext('2d');
            chartPieA=new Chart(ctxPie,{type:'pie',data:{labels:pieLabels,datasets:[{data:pieData,backgroundColor:['#E74C3C','#F0C808','#086788','#2ECC71','#9B59B6']}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:tooltipCurrencyCallback}}});
        }

        function renderDetailChartsB(row){
            const total=parseMoney(row['é ç®—é‡‘é¡']);
            const cut=parseMoney(row['åˆªæ¸›é‡‘é¡']);
            const freeze=parseMoney(row['å‡çµé‡‘é¡']);
            const pass=total-cut-freeze;
            
            const ctx1=document.getElementById('chartBResult').getContext('2d');
            chartB1=new Chart(ctx1,{type:'bar',data:{labels:['çµæœ'],datasets:[{label:'é€šé',data:[pass],backgroundColor:'#086788'},{label:'å‡çµ',data:[freeze],backgroundColor:'#F0C808'},{label:'åˆªæ¸›',data:[cut],backgroundColor:'#E74C3C'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}},plugins:{tooltip:tooltipCurrencyCallback}}});
            
            // â˜…â˜…â˜… é›™ä¿éšªè®€å–æ³•ï¼šå¦‚æœæ‰¾ä¸åˆ°æ–°æ¬„ä½ï¼Œå°±å˜—è©¦è®€å–èˆŠæ¬„ä½ â˜…â˜…â˜…
            
            // 1. å§”å“¡æœƒéšæ®µ
            const cCut = parseMoney(row['å§”å“¡æœƒåˆªæ¸›']);
            const cFreeze = parseMoney(row['å§”å“¡æœƒå‡çµ']);
            
            // 2. é™¢æœƒè¡¨æ±ºéšæ®µ (åŸ: å”å•†)
            const nCut = parseMoney(row['é™¢æœƒè¡¨æ±ºåˆªæ¸›'] || row['å”å•†åˆªæ¸›']); 
            const nFreeze = parseMoney(row['é™¢æœƒè¡¨æ±ºå‡çµ'] || row['å”å•†å‡çµ']);
            
            // 3. é€šæ¡ˆéšæ®µ (åŸ: é™¢æœƒ)
            const fCut = parseMoney(row['é€šæ¡ˆåˆªæ¸›'] || row['é™¢æœƒåˆªæ¸›']); 
            const fFreeze = parseMoney(row['é€šæ¡ˆå‡çµ'] || row['é™¢æœƒå‡çµ']);

            const ctx2=document.getElementById('chartBStages').getContext('2d');
            chartB2=new Chart(ctx2,{type:'bar',data:{
                labels:['å§”å“¡æœƒ','é™¢æœƒè¡¨æ±º','é€šæ¡ˆ'],
                datasets:[{label:'åˆªæ¸›',data:[cCut,nCut,fCut],backgroundColor:'#E74C3C'},{label:'å‡çµ',data:[cFreeze,nFreeze,fFreeze],backgroundColor:'#F0C808'}]
            },options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:tooltipCurrencyCallback}}});
        }
    </script>
</body>
</html>
