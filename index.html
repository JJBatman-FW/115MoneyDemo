<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ”¿åºœç¸½é ç®—è§€æ¸¬ç«™ (æ”¯æ´çµ±åˆªè¨ˆç®—ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --success-color: #2ecc71;
            --bg-color: #f4f7f6;
            --text-color: #333;
        }
        body { font-family: "Noto Sans TC", sans-serif; background-color: var(--bg-color); margin: 0; line-height: 1.6; color: var(--text-color); }
        
        /* Header */
        header { background-color: var(--primary-color); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.5rem; cursor: pointer; }
        nav button { background: transparent; border: 1px solid white; color: white; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        nav button:hover { background: rgba(255,255,255,0.2); }

        /* Main & Layout */
        main { padding: 2rem; max-width: 1200px; margin: 0 auto; min-height: 80vh; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 3rem; }
        .big-btn { padding: 2rem; width: 250px; border: none; border-radius: 12px; cursor: pointer; color: white; font-weight: bold; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
        .big-btn:hover { transform: translateY(-5px); }
        .btn-a { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-b { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: #444; }
        .btn-c { background: linear-gradient(135deg, #84fab0, #8fd3f4); color: #444; }

        /* Search Bar */
        .search-wrapper { margin: 2rem 0; text-align: center; }
        .search-input-lg { width: 100%; max-width: 600px; padding: 15px 25px; font-size: 1.1rem; border: 2px solid #e0e0e0; border-radius: 50px; outline: none; transition: 0.3s; }
        .search-input-lg:focus { border-color: var(--accent-color); }

        /* --- åˆ†é  A å¡ç‰‡ --- */
        .project-block {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--accent-color);
            transition: transform 0.2s; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; cursor: pointer;
        }
        .project-block:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); background-color: #fcfcfc; }
        .pb-info { flex: 1; min-width: 200px; }
        .pb-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin: 0 0 5px 0; }
        .pb-dept { background: #ecf0f1; color: #7f8c8d; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .pb-amount { font-size: 1.4rem; color: #2980b9; font-weight: 800; margin-left: 20px; white-space: nowrap; }

        /* --- åˆ†é  B æ’è¡Œæ¦œ --- */
        .ranking-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; }
        @media (max-width: 768px) { .ranking-container { grid-template-columns: 1fr; } }
        .rank-column h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--primary-color); }
        .rank-group { margin-bottom: 30px; }
        .rank-group h4 { margin: 10px 0; color: #666; font-size: 1rem; }
        .rank-list { list-style: none; padding: 0; }
        .rank-list li { padding: 12px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; }
        .rank-list li:nth-child(-n+3) .rank-idx { background: var(--accent-color); color: white; }
        .rank-idx { display: inline-block; width: 24px; height: 24px; background: #ddd; color: #555; text-align: center; line-height: 24px; border-radius: 50%; margin-right: 10px; font-size: 0.8rem; }
        .rank-val { font-weight: bold; }
        .color-cut { color: var(--danger-color); }
        .color-freeze { color: var(--warning-color); }

        /* --- åˆ†é  B å¡ç‰‡ --- */
        .review-block {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer;
            transition: transform 0.2s; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;
        }
        .review-block:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-cut { border-left-color: var(--danger-color); }
        .status-freeze { border-left-color: var(--warning-color); }
        .status-pass { border-left-color: var(--success-color); }
        .rb-header h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: #333; }
        .rb-meta { font-size: 0.9rem; color: #777; display: flex; gap: 10px; align-items: center; }
        .rb-tag { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .rb-status-box { text-align: right; }
        .rb-status-label { display: inline-block; padding: 5px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .bg-cut { background: var(--danger-color); }
        .bg-freeze { background: var(--warning-color); }
        .bg-pass { background: var(--success-color); }
        .rb-amount { font-size: 1.2rem; font-weight: bold; color: #555; }

        /* Loading & Modal */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 15px; padding: 30px; position: relative; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { position: absolute; top: 15px; right: 25px; font-size: 2.5rem; cursor: pointer; color: #aaa; line-height: 0.8; }
        
        .detail-header { border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .mini-chart-box { text-align: center; background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px; }

        /* Proposal Table */
        .proposal-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        .proposal-table th, .proposal-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .proposal-table th { background-color: #f8f9fa; color: #555; font-weight: bold; }
        .proposal-table tr:hover { background-color: #fcfcfc; }
        .p-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color: white;}
        .p-cut { background: var(--danger-color); }
        .p-freeze { background: var(--warning-color); }

    </style>
</head>
<body>

    <div id="loader" class="loading-overlay"><div class="spinner"></div><p>è³‡æ–™è¼‰å…¥ä¸­...</p></div>

    <div id="detailModal" class="modal-overlay" onclick="closeModal(event, 'detailModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'detailModal')">&times;</span>
            <div class="detail-header">
                <h2 id="m-title" style="margin:0; color:#2c3e50;">è¨ˆç•«åç¨±</h2>
                <div style="margin-top:5px; color:#666;">
                    <span id="m-dept" class="pb-dept">æ©Ÿé—œ</span>
                    <span id="m-amount" style="font-weight:bold; color:#e74c3c; margin-left:10px;">é‡‘é¡</span>
                </div>
            </div>
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                <strong>ğŸ“ å…§å®¹ï¼š</strong> <span id="m-desc"></span>
            </div>
            <div class="modal-charts-grid">
                <div class="mini-chart-box"><h4>ğŸ“Š åˆ†æ”¯è¨ˆç•«</h4><div style="height:250px;"><canvas id="chartDetailBar"></canvas></div></div>
                <div class="mini-chart-box"><h4>ğŸ° ç”¨é€”æ¯”ä¾‹</h4><div style="height:250px;"><canvas id="chartDetailPie"></canvas></div></div>
            </div>
        </div>
    </div>

    <div id="detailModalB" class="modal-overlay" onclick="closeModal(event, 'detailModalB')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'detailModalB')">&times;</span>
            <div class="detail-header">
                <h2 id="mb-title" style="margin:0; color:#2c3e50;">è¨ˆç•«åç¨±</h2>
                <div style="margin-top:10px; display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                    <span id="mb-dept" class="pb-dept">æ©Ÿé—œ</span>
                    <span style="color:#666; font-size:1rem;">åŸåˆ—é ç®—ï¼š<strong id="mb-budget" style="color:#2980b9; font-size:1.2rem;"></strong></span>
                </div>
            </div>
            <div class="modal-charts-grid">
                <div class="mini-chart-box"><h4>âœ‚ï¸ æœ€çµ‚å¯©æŸ¥çµæœæ¯”ä¾‹</h4><div style="height:250px;"><canvas id="chartBResult"></canvas></div></div>
                <div class="mini-chart-box"><h4>âš–ï¸ ä¸‰éšæ®µåˆªå‡æ¯”è¼ƒ</h4><div style="height:250px;"><canvas id="chartBStages"></canvas></div></div>
            </div>
            <div style="margin-top: 30px;">
                <h3 style="border-left: 5px solid var(--accent-color); padding-left: 10px;">ğŸ“„ å§”å“¡ææ¡ˆç´€éŒ„</h3>
                <div style="overflow-x: auto;">
                    <table class="proposal-table">
                        <thead><tr><th style="width:15%">ææ¡ˆå§”å“¡</th><th style="width:20%">é¡åˆ¥/é‡‘é¡</th><th>ææ¡ˆç†ç”±</th></tr></thead>
                        <tbody id="proposal-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <header>
        <h1 onclick="showPage('home')">ğŸ“Š ä¸­å¤®æ”¿åºœç¸½é ç®—è§€æ¸¬ç«™</h1>
        <nav><button onclick="showPage('home')">å›é¦–é </button></nav>
    </header>

    <main>
        <section id="home" class="page-section active">
            <div class="hero">
                <h2>æ¯ä¸€ç­†ç´ç¨…éŒ¢ï¼Œéƒ½å€¼å¾—è¢«çœ‹è¦‹</h2>
                <div class="btn-group">
                    <button class="big-btn btn-a" onclick="showPage('page-a')">åˆ†é  A<br>é ç®—ç¸½è¦½</button>
                    <button class="big-btn btn-b" onclick="showPage('page-b')">åˆ†é  B<br>å¯©æŸ¥åˆªæ¸›</button>
                    <button class="big-btn btn-c" onclick="showPage('page-c')">åˆ†é  C<br>ç«‹å§”æŠŠé—œ</button>
                </div>
            </div>
        </section>

        <section id="page-a" class="page-section">
            <h2>ğŸ’° ä»Šå¹´ç¸½é ç®—å¦‚ä½•ç·¨åˆ—ï¼Ÿ</h2>
            <div class="card"><h3>æ­·å¹´æ­²å‡ºé ç®—æ¯”è¼ƒ</h3><div class="chart-container"><canvas id="chartYearly"></canvas></div></div>
            <div class="card"><h3>114 å¹´åº¦é ç®—åˆ†é…æ¦‚æ³</h3><div class="chart-container"><canvas id="chartAllocation"></canvas></div></div>
            <div style="margin-top: 3rem;">
                <h3 style="text-align: center;">ğŸ” æŸ¥çœ‹è©³ç´°åˆ†æ”¯è¨ˆç•«</h3>
                <div class="search-wrapper"><input type="text" class="search-input-lg" placeholder="æœå°‹ï¼šåœ‹é˜²ã€é•·ç…§..." oninput="handleSearchPageA(this.value)"></div>
                <div id="results-container-a"></div>
            </div>
        </section>

        <section id="page-b" class="page-section">
            <h2>âœ‚ï¸ å“ªç­†é ç®—è¢«åˆªæœ€å¤šï¼Ÿ</h2>
            <div class="card">
                <h3>ç¸½é ç®—å¯©æŸ¥æ¯”ä¾‹æ¦‚æ³</h3>
                <div style="height: 100px;"><canvas id="chartStatusB"></canvas></div>
                <div style="text-align:center; font-size:0.9rem; color:#666; margin-top:10px;">èªªæ˜ï¼šæ­¤åœ–è¡¨åŒ…å«å„å·¥ä½œè¨ˆç•«åˆªæ¸›èˆ‡éƒ¨æœƒé€šæ¡ˆåˆªæ¸›ä¹‹ç¸½å’Œã€‚</div>
            </div>
            <div class="ranking-container">
                <div class="card rank-column">
                    <h3>ğŸ›ï¸ éƒ¨æœƒæ©Ÿé—œ Top 5</h3>
                    <div class="rank-group"><h4>âœ‚ï¸ åˆªæ¸›é‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-dept-cut"></ul></div>
                    <div class="rank-group"><h4>â„ï¸ å‡çµé‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-dept-freeze"></ul></div>
                </div>
                <div class="card rank-column">
                    <h3>ğŸ“‹ å·¥ä½œè¨ˆç•« Top 5</h3>
                    <div class="rank-group"><h4>âœ‚ï¸ åˆªæ¸›é‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-plan-cut"></ul></div>
                    <div class="rank-group"><h4>â„ï¸ å‡çµé‡‘é¡æœ€å¤š</h4><ul class="rank-list" id="rank-plan-freeze"></ul></div>
                </div>
            </div>
            <div style="margin-top: 3rem;">
                <h3 style="text-align: center; color: var(--primary-color);">ğŸ” æŸ¥æ‰¾è¨ˆç•«å¯©æŸ¥çµæœ</h3>
                <div class="search-wrapper"><input type="text" class="search-input-lg" placeholder="è¼¸å…¥é—œéµå­—..." oninput="handleSearchPageB(this.value)"></div>
                <div id="results-container-b"></div>
            </div>
        </section>

        <section id="page-c" class="page-section">
            <h2>âš–ï¸ ç«‹å§”æŠŠé—œç´€éŒ„</h2>
            <div class="legislator-grid" id="leg-container-c"></div>
        </section>
    </main>

    <script>
        // ==========================================
        // 1. è¨­å®šå€
        // ==========================================
        const dataSources = {
            'page-a': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6ZFEMdgBFyC6O0Axmx7TvcckTzMoDCxrb5V_8gHJmyzBEXx-cLj6RtRWkyUUap-qiK_C2G-GwJFMJ/pub?gid=612819456&single=true&output=csv', 
            // è«‹å¡«å…¥æ‚¨æ–°æ•´ç†å¥½çš„åˆ†é  B CSV é€£çµ
            'page-b': '', 
            'page-c': ''
        };
        
        let allDataPageA = []; 
        let allDataPageB = [];
        let allDataPageB_Plans = []; // åªå­˜ã€Œè¨ˆç•«ã€ä¸å­˜ã€Œçµ±åˆªã€
        let mainChartsRendered = false;

        // ==========================================
        // 2. é é¢åˆ‡æ›
        // ==========================================
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
            
            if (pageId === 'page-a') {
                renderMainCharts();
                if(allDataPageA.length === 0) fetchData('page-a');
            }
            if (pageId === 'page-b') {
                if(allDataPageB.length === 0) fetchData('page-b');
            }
        }

        function renderMainCharts() {
            if(mainChartsRendered) return;
            new Chart(document.getElementById('chartYearly').getContext('2d'), { type: 'bar', data: { labels: ['110å¹´', '111å¹´', '112å¹´', '113å¹´', '114å¹´(è‰æ¡ˆ)'], datasets: [{ label: 'æ­²å‡ºç¸½é¡', data: [22000, 23500, 26890, 28800, 31000], backgroundColor: '#3498db' }] }, options: { responsive: true, maintainAspectRatio: false } });
            new Chart(document.getElementById('chartAllocation').getContext('2d'), { type: 'doughnut', data: { labels: ['ç¤¾ç¦', 'æ•™è‚²', 'åœ‹é˜²', 'ç¶“æ¿Ÿ', 'å…¶ä»–'], datasets: [{ data: [26, 19, 16, 12, 27], backgroundColor: ['#ff6384', '#36a2eb', '#4bc0c0', '#ff9f40', '#9966ff'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            mainChartsRendered = true;
        }

        // ==========================================
        // 3. è³‡æ–™è®€å–
        // ==========================================
        function fetchData(pageId) {
            let url = dataSources[pageId];
            const loader = document.getElementById('loader');

            if (!url) {
                if(pageId === 'page-b') mockDataForDemo(pageId);
                return;
            }

            if (url.includes('http')) { url = 'https://corsproxy.io/?' + encodeURIComponent(url); }

            loader.style.display = 'flex';
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (pageId === 'page-a') {
                        allDataPageA = results.data;
                        displayProjectBlocks(allDataPageA);
                    } else if (pageId === 'page-b') {
                        allDataPageB = results.data;
                        processPageBData(allDataPageB);
                    }
                    loader.style.display = 'none';
                },
                error: function() { loader.style.display = 'none'; alert('è®€å–å¤±æ•—'); }
            });
        }

        // ==========================================
        // 4. åˆ†é  A é‚è¼¯
        // ==========================================
        function displayProjectBlocks(data) {
            const container = document.getElementById('results-container-a');
            if(!data || data.length === 0) { container.innerHTML = '<p align="center">ç„¡è³‡æ–™</p>'; return; }
            let html = '';
            data.forEach(row => {
                if(!row['è¨ˆç•«åç¨±']) return;
                const rowStr = encodeURIComponent(JSON.stringify(row));
                html += `<div class="project-block" onclick="openDetail('${rowStr}')"><div class="pb-info"><h3 class="pb-title">${row['è¨ˆç•«åç¨±']}</h3><span class="pb-dept">${row['ä¸»ç®¡æ©Ÿé—œ']}</span></div><div class="pb-amount">NT$ ${row['é ç®—é‡‘é¡']}</div></div>`;
            });
            container.innerHTML = html;
        }
        function handleSearchPageA(val) {
            if (!val.trim()) { displayProjectBlocks(allDataPageA); return; }
            const lower = val.toLowerCase();
            const filtered = allDataPageA.filter(r => (r['è¨ˆç•«åç¨±']||'').toLowerCase().includes(lower) || (r['å·¥ä½œå…§å®¹']||'').toLowerCase().includes(lower));
            displayProjectBlocks(filtered);
        }

        let chartBar = null, chartPie = null;
        function openDetail(str) {
            const row = JSON.parse(decodeURIComponent(str));
            document.getElementById('m-title').innerText = row['è¨ˆç•«åç¨±'];
            document.getElementById('m-dept').innerText = row['ä¸»ç®¡æ©Ÿé—œ'];
            document.getElementById('m-amount').innerText = 'NT$ ' + row['é ç®—é‡‘é¡'];
            document.getElementById('m-desc').innerText = row['å·¥ä½œå…§å®¹'] || 'ç„¡';
            document.getElementById('detailModal').style.display = 'flex';
            if(chartBar) chartBar.destroy(); if(chartPie) chartPie.destroy();
            renderDetailCharts(row);
        }
        function renderDetailCharts(row) {
             let subLabels = [], subData = [];
             let branchString = row['åˆ†æ”¯è¨ˆç•«'] || '';
             if(branchString && branchString.includes(':')) {
                 branchString.split('|').forEach(item => { let parts = item.split(':'); if (parts.length === 2) { subLabels.push(parts[0].trim()); subData.push(parseInt(parts[1].trim())); }});
             } else { subLabels = ['æš«ç„¡è©³ç´°åˆ†æ”¯']; subData = [0]; }
             let pieLabels = [], pieData = [];
             let usageString = row['ç”¨é€”æ¯”ä¾‹'] || '';
             if(usageString && usageString.includes(':')) {
                 usageString.split('|').forEach(item => { let parts = item.split(':'); if (parts.length === 2) { pieLabels.push(parts[0].trim()); pieData.push(parseInt(parts[1].trim())); }});
             } else { pieLabels = ['æš«ç„¡è³‡æ–™']; pieData = [1]; }
             
             const ctxBar = document.getElementById('chartDetailBar').getContext('2d');
             chartBar = new Chart(ctxBar, { type: 'bar', data: { labels:subLabels, datasets:[{label:'é‡‘é¡',data:subData, backgroundColor:'#3498db', borderRadius:4}] }, options:{indexAxis:'y', maintainAspectRatio:false, plugins:{legend:{display:false}}} });
             const ctxPie = document.getElementById('chartDetailPie').getContext('2d');
             chartPie = new Chart(ctxPie, { type: 'pie', data: { labels:pieLabels, datasets:[{data:pieData, backgroundColor:['#e74c3c','#f1c40f','#2ecc71','#3498db','#95a5a6']}] }, options:{maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}} });
        }

        // ==========================================
        // 5. åˆ†é  B é‚è¼¯ (æ”¯æ´çµ±åˆªèˆ‡è¨ˆç•«å€åˆ†)
        // ==========================================
        function parseMoney(str) {
            if(!str) return 0;
            let val = parseFloat(str.replace(/,/g, '').replace(/[^0-9.-]/g, ''));
            if(str.includes('å„„')) val = val * 100000000;
            else if(str.includes('è¬')) val = val * 10000;
            return isNaN(val) ? 0 : val;
        }

        function processPageBData(data) {
            let totalCut = 0, totalFreeze = 0, totalBudget = 0;
            let deptStats = {}; 
            
            // æ¸…ç©ºè¨ˆç•«åˆ—è¡¨ï¼Œæº–å‚™ç¯©é¸
            allDataPageB_Plans = [];

            data.forEach(row => {
                const amount = parseMoney(row['é ç®—é‡‘é¡']);
                const cut = parseMoney(row['åˆªæ¸›é‡‘é¡']);
                const freeze = parseMoney(row['å‡çµé‡‘é¡']);
                const dept = row['ä¸»ç®¡æ©Ÿé—œ'] || 'å…¶ä»–';
                const type = row['è³‡æ–™é¡å‹'] || 'è¨ˆç•«'; // å–å¾—é¡å‹

                // 1. ç¸½é«”çµ±è¨ˆï¼šä¸ç®¡æ˜¯ä¸æ˜¯çµ±åˆªï¼Œå…¨éƒ¨åŠ ç¸½
                totalBudget += amount;
                totalCut += cut;
                totalFreeze += freeze;

                // 2. éƒ¨æœƒçµ±è¨ˆï¼šä¸ç®¡æ˜¯ä¸æ˜¯çµ±åˆªï¼Œå…¨éƒ¨åŠ ç¸½
                if(!deptStats[dept]) deptStats[dept] = { name: dept, cut: 0, freeze: 0 };
                deptStats[dept].cut += cut;
                deptStats[dept].freeze += freeze;

                // 3. ç¯©é¸ã€Œè¨ˆç•«ã€ï¼šåªæœ‰é¡å‹æ˜¯ã€Œè¨ˆç•«ã€çš„æ‰æ”¾é€² allDataPageB_Plans
                // é€™æ¨£å³æ¬„æ’è¡Œå’Œä¸‹æ–¹å¡ç‰‡å°±ä¸æœƒå‡ºç¾ã€Œçµ±åˆªæ¡ˆã€
                if (type === 'è¨ˆç•«') {
                    allDataPageB_Plans.push(row);
                }
            });

            // ç¹ªè£½ç¸½é«”åœ–è¡¨
            const totalPass = totalBudget - totalCut - totalFreeze;
            new Chart(document.getElementById('chartStatusB').getContext('2d'), {
                type: 'bar',
                data: { labels: ['ç¸½é«”å¯©æŸ¥çµæœ'], datasets: [
                    { label: 'åˆªæ¸›', data: [totalCut], backgroundColor: '#e74c3c', barThickness: 40 },
                    { label: 'å‡çµ', data: [totalFreeze], backgroundColor: '#f1c40f', barThickness: 40 },
                    { label: 'é€šé', data: [totalPass], backgroundColor: '#2ecc71', barThickness: 40 }
                ]},
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, plugins: { legend: { position: 'top' } } }
            });

            // æ¸²æŸ“å·¦æ¬„ï¼šéƒ¨æœƒæ’è¡Œ (åŒ…å«çµ±åˆªé‡‘é¡)
            const deptArray = Object.values(deptStats);
            renderRankList('rank-dept-cut', [...deptArray].sort((a,b)=>b.cut-a.cut).slice(0,5), 'cut');
            renderRankList('rank-dept-freeze', [...deptArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5), 'freeze');

            // æ¸²æŸ“å³æ¬„ï¼šè¨ˆç•«æ’è¡Œ (æ’é™¤çµ±åˆªï¼Œåªç”¨ allDataPageB_Plans)
            const planArray = allDataPageB_Plans.map(r => ({ name: r['è¨ˆç•«åç¨±'], cut: parseMoney(r['åˆªæ¸›é‡‘é¡']), freeze: parseMoney(r['å‡çµé‡‘é¡']) })).filter(r=>r.name);
            renderRankList('rank-plan-cut', [...planArray].sort((a,b)=>b.cut-a.cut).slice(0,5), 'cut');
            renderRankList('rank-plan-freeze', [...planArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5), 'freeze');

            // åˆå§‹é¡¯ç¤ºå¡ç‰‡ (åªé¡¯ç¤ºè¨ˆç•«)
            displayPageBBlocks(allDataPageB_Plans);
        }

        function renderRankList(elementId, list, type) {
            const el = document.getElementById(elementId);
            if(!list || list.length === 0) { el.innerHTML = '<li>ç„¡è³‡æ–™</li>'; return; }
            let html = '';
            list.forEach((item, index) => {
                let val = type === 'cut' ? item.cut : item.freeze;
                let valDisplay = val > 100000000 ? (val/100000000).toFixed(1)+'å„„' : (val/10000).toFixed(0)+'è¬';
                let colorClass = type === 'cut' ? 'color-cut' : 'color-freeze';
                html += `<li><span><span class="rank-idx">${index + 1}</span> ${item.name}</span><span class="rank-val ${colorClass}">${valDisplay}</span></li>`;
            });
            el.innerHTML = html;
        }

        // B æœå°‹ï¼šåªæœå°‹ allDataPageB_Plans
        function handleSearchPageB(val) {
            if (!val.trim()) { displayPageBBlocks(allDataPageB_Plans); return; }
            const lower = val.toLowerCase();
            const filtered = allDataPageB_Plans.filter(r => (r['è¨ˆç•«åç¨±']||'').toLowerCase().includes(lower) || (r['ä¸»ç®¡æ©Ÿé—œ']||'').toLowerCase().includes(lower));
            displayPageBBlocks(filtered);
        }

        function displayPageBBlocks(data) {
            const container = document.getElementById('results-container-b');
            if(!data || data.length === 0) { container.innerHTML = '<p align="center">ç„¡è³‡æ–™</p>'; return; }
            let html = '';
            data.forEach(row => {
                const rowStr = encodeURIComponent(JSON.stringify(row));
                const status = row['å¯©æŸ¥é€²åº¦'] || 'æœªå¯©æŸ¥';
                let statusClass = '', bgClass = 'bg-pass';
                if(status.includes('åˆª')) { statusClass = 'status-cut'; bgClass = 'bg-cut'; }
                else if(status.includes('å‡')) { statusClass = 'status-freeze'; bgClass = 'bg-freeze'; }
                else { statusClass = 'status-pass'; }
                html += `<div class="review-block ${statusClass}" onclick="openDetailB('${rowStr}')"><div class="rb-info"><div class="rb-header"><h3>${row['è¨ˆç•«åç¨±']}</h3><div class="rb-meta"><span class="rb-tag">${row['ä¸»ç®¡æ©Ÿé—œ']}</span></div></div></div><div class="rb-status-box"><span class="rb-status-label ${bgClass}">${status}</span><div class="rb-amount">NT$ ${row['é ç®—é‡‘é¡']}</div></div></div>`;
            });
            container.innerHTML = html;
        }

        // Modal B
        let chartB1 = null, chartB2 = null;
        function openDetailB(str) {
            const row = JSON.parse(decodeURIComponent(str));
            document.getElementById('mb-title').innerText = row['è¨ˆç•«åç¨±'];
            document.getElementById('mb-dept').innerText = row['ä¸»ç®¡æ©Ÿé—œ'];
            document.getElementById('mb-budget').innerText = row['é ç®—é‡‘é¡'] || '0';
            document.getElementById('detailModalB').style.display = 'flex';
            if(chartB1) chartB1.destroy(); if(chartB2) chartB2.destroy();
            renderDetailChartsB(row);
            renderProposalTable(row);
        }

        function renderDetailChartsB(row) {
            const total = parseMoney(row['é ç®—é‡‘é¡']);
            const cut = parseMoney(row['åˆªæ¸›é‡‘é¡']);
            const freeze = parseMoney(row['å‡çµé‡‘é¡']);
            const pass = total - cut - freeze;

            const ctx1 = document.getElementById('chartBResult').getContext('2d');
            chartB1 = new Chart(ctx1, { type: 'bar', data: { labels: ['çµæœ'], datasets: [{ label: 'åˆªæ¸›', data: [cut], backgroundColor: '#e74c3c' }, { label: 'å‡çµ', data: [freeze], backgroundColor: '#f1c40f' }, { label: 'é€šé', data: [pass], backgroundColor: '#2ecc71' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });

            const ctx2 = document.getElementById('chartBStages').getContext('2d');
            chartB2 = new Chart(ctx2, { type: 'bar', data: { labels: ['å§”å“¡æœƒ', 'é»¨åœ˜å”å•†', 'é™¢æœƒ'], datasets: [{ label: 'åˆªæ¸›', data: [cut * 0.7, cut * 0.2, cut * 0.1], backgroundColor: '#e74c3c' }, { label: 'å‡çµ', data: [freeze * 0.5, freeze * 0.3, freeze * 0.2], backgroundColor: '#f1c40f' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function renderProposalTable(row) {
            const tbody = document.getElementById('proposal-table-body');
            tbody.innerHTML = '';
            const proposalStr = row['ææ¡ˆç´€éŒ„'] || '';
            if(!proposalStr) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">æš«ç„¡è©³ç´°ææ¡ˆè³‡æ–™</td></tr>'; return; }
            proposalStr.split('|').forEach(p => {
                const parts = p.split(':'); if(parts.length >= 3) {
                    const typeClass = parts[1].includes('åˆª') ? 'p-cut' : 'p-freeze';
                    tbody.innerHTML += `<tr><td><strong>${parts[0]}</strong></td><td><span class="p-tag ${typeClass}">${parts[1]}</span></td><td>${parts[2]}</td></tr>`;
                }
            });
        }

        function closeModal(e, modalId) {
            if(e && e.target !== e.currentTarget && e.target.className!=='close-btn') return;
            document.getElementById(modalId).style.display = 'none';
        }

        // æ¨¡æ“¬è³‡æ–™ (åˆ†é  B)
        function mockDataForDemo(pageId) {
            if (pageId === 'page-b') {
                const mockB = [
                    { 'è³‡æ–™é¡å‹': 'è¨ˆç•«', 'è¨ˆç•«åç¨±': 'æ•¸ä½èº«åˆ†è­‰è³‡å®‰å¼·åŒ–', 'ä¸»ç®¡æ©Ÿé—œ': 'æ•¸ä½éƒ¨', 'é ç®—é‡‘é¡': '5å„„', 'åˆªæ¸›é‡‘é¡': '5,000è¬', 'å‡çµé‡‘é¡': '1å„„', 'å¯©æŸ¥é€²åº¦': 'å‡çµ1å„„', 'ææ¡ˆç´€éŒ„': 'ç‹å¤§æ˜:åˆªæ¸›5000è¬:è³‡å®‰ç–‘æ…®æœªé™¤|é™³å°ç¾:å‡çµ1å„„:å¾…å ±å‘Š' },
                    { 'è³‡æ–™é¡å‹': 'è¨ˆç•«', 'è¨ˆç•«åç¨±': 'æ½›è‰¦åœ‹é€ å¾ŒçºŒè‰¦', 'ä¸»ç®¡æ©Ÿé—œ': 'åœ‹é˜²éƒ¨', 'é ç®—é‡‘é¡': '200å„„', 'åˆªæ¸›é‡‘é¡': '0', 'å‡çµé‡‘é¡': '50å„„', 'å¯©æŸ¥é€²åº¦': 'å‡çµ50å„„', 'ææ¡ˆç´€éŒ„': 'æ—å¿—å¼·:å‡çµ50å„„:åŸå‹è‰¦æ¸¬è©¦æœªå®Œ' },
                    { 'è³‡æ–™é¡å‹': 'çµ±åˆª', 'è¨ˆç•«åç¨±': 'åœ‹é˜²éƒ¨é€šæ¡ˆåˆªæ¸›', 'ä¸»ç®¡æ©Ÿé—œ': 'åœ‹é˜²éƒ¨', 'é ç®—é‡‘é¡': '0', 'åˆªæ¸›é‡‘é¡': '5å„„', 'å‡çµé‡‘é¡': '0', 'å¯©æŸ¥é€²åº¦': 'çµ±åˆª5å„„', 'ææ¡ˆç´€éŒ„': '' },
                    { 'è³‡æ–™é¡å‹': 'è¨ˆç•«', 'è¨ˆç•«åç¨±': 'é›¢å²¸é¢¨é›»æ¨å»£', 'ä¸»ç®¡æ©Ÿé—œ': 'ç¶“æ¿Ÿéƒ¨', 'é ç®—é‡‘é¡': '30å„„', 'åˆªæ¸›é‡‘é¡': '2å„„', 'å‡çµé‡‘é¡': '0', 'å¯©æŸ¥é€²åº¦': 'åˆªæ¸›2å„„', 'ææ¡ˆç´€éŒ„': 'ç‹å¤§æ˜:åˆªæ¸›2å„„:åŸ·è¡Œç‡ä½' }
                ];
                allDataPageB = mockB;
                processPageBData(mockB);
            }
        }
    </script>
</body>
</html>
