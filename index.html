<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中央政府總預算觀測站 (Query API 修正版)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* --- 基礎設定 (v56 現代高對比配色) --- */
        :root {
            --bg-color: #F8F8F8; --primary-color: #070707; --secondary-color: #086788;
            --accent-color: #F0C808; --highlight-color: #A6DAEE;
            --danger-color: #E74C3C; --warning-color: var(--accent-color); --success-color: var(--secondary-color);
            --card-bg: #FFFFFF; --border-color: #e0e0e0;
            --party-kmt: #000095; --party-dpp: #1b9431; --party-tpp: #28c7c7; --party-npp: #f9be01; --party-other: #7f8c8d;
        }
        * { box-sizing: border-box; }
        body { font-family: "Noto Sans TC", sans-serif; background-color: var(--bg-color); margin: 0; line-height: 1.6; color: var(--primary-color); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Header */
        header { background-color: var(--card-bg); color: var(--primary-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-bottom: 3px solid var(--secondary-color); }
        header h1 { margin: 0; font-size: 1.4rem; cursor: pointer; white-space: nowrap; font-weight: 900; letter-spacing: 1px; color: var(--secondary-color); }
        header nav { display: flex; gap: 10px; }
        header nav button { background: transparent; border: 2px solid var(--secondary-color); color: var(--secondary-color); padding: 6px 12px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; font-weight: bold; }
        header nav button:hover { background: var(--secondary-color); color: white; transform: translateY(-1px); }
        .nav-active { background: var(--secondary-color) !important; color: white !important; border-color: var(--secondary-color) !important; }
        @media (max-width: 680px) { header { flex-direction: column; gap: 15px; padding: 1rem; } header nav { width: 100%; justify-content: center; flex-wrap: wrap; } header nav button { flex: 1; min-width: 80px; text-align: center; } }

        /* Main */
        main { padding: 2rem; max-width: 1200px; margin: 0 auto; flex: 1; width: 100%; }
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Footer */
        footer { background-color: var(--bg-color); color: #555; padding: 3rem 1rem; text-align: center; margin-top: auto; font-size: 0.9rem; border-top: 4px solid var(--secondary-color); }
        .footer-content { max-width: 800px; margin: 0 auto; }
        .footer-disclaimer { background: rgba(8, 103, 136, 0.1); color: var(--secondary-color); display: inline-block; padding: 8px 15px; border-radius: 8px; border: 1px solid var(--secondary-color); font-weight: bold; margin-top: 10px; }

        /* Components */
        .section-title { text-align: center; margin: 3rem 0 1.5rem 0; color: var(--primary-color); position: relative; font-weight: 800; }
        .section-title::after { content: ''; display: block; width: 60px; height: 5px; background: var(--accent-color); margin: 15px auto 0; border-radius: 3px; }
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; overflow: hidden; border: 1px solid var(--border-color); }
        .card h3 { color: var(--primary-color); margin-top: 0; font-weight: 700; border-bottom: 2px solid var(--bg-color); padding-bottom: 10px; position: relative; }
        .card h3::before { content:''; position: absolute; left:-1.5rem; top: 5px; height: 1.2em; width: 6px; background: var(--secondary-color); border-radius: 0 4px 4px 0;}
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* Bill Container */
        .bill-container { position: relative; width: 100%; aspect-ratio: 16 / 7; background-image: url('1000.png'); background-size: 100% 100%; background-position: center; background-repeat: no-repeat; border-radius: 8px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); padding: 0; overflow: hidden; border: 2px solid var(--secondary-color); box-sizing: border-box; }
        .bill-container canvas { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; display: block; }

        /* Legend */
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; padding: 15px; background: rgba(8, 103, 136, 0.05); border-radius: 8px; border: 1px solid var(--border-color); }
        .legend-item { display: flex; align-items: center; font-size: 0.95rem; color: var(--primary-color); cursor: default; font-weight: 500; }
        .legend-color-box { width: 14px; height: 14px; border-radius: 3px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }

        /* Buttons & Search */
        .btn-group { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 1rem; }
        .big-btn { padding: 1.5rem; width: 220px; border: none; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s, filter 0.2s; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
        .big-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); filter: brightness(1.1); }
        .btn-a { background: linear-gradient(135deg, var(--secondary-color), #0a7ea6); color: white; }
        .btn-c { background: linear-gradient(135deg, var(--accent-color), #ffd500); color: var(--primary-color); }
        .search-wrapper { margin: 2rem 0; text-align: center; width: 100%; }
        .search-input-lg { width: 100%; max-width: 600px; padding: 15px 25px; font-size: 1.1rem; border: 3px solid var(--border-color); border-radius: 50px; outline: none; transition: 0.3s; background-color: var(--card-bg); color: var(--primary-color); }
        .search-input-lg:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 4px rgba(8, 103, 136, 0.15); }

        /* Project Block */
        .project-block { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, border-color 0.2s; display: grid; grid-template-columns: 1fr auto; gap: 15px; cursor: pointer; border: 2px solid var(--border-color); border-left: 8px solid var(--accent-color); }
        .project-block:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--secondary-color); }
        .pb-info { display:flex; flex-direction:column; justify-content:center; min-width: 0; }
        .pb-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin: 0 0 8px 0; word-break: break-word; }
        .pb-dept { background: var(--bg-color); color: var(--secondary-color); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; width: fit-content; border: 1px solid rgba(8, 103, 136, 0.3); }
        .pb-amount { font-size: 1.5rem; color: var(--secondary-color); font-weight: 900; white-space: nowrap; text-align: right; }

        /* Ranking */
        .ranking-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; }
        .rank-column h3 { border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; color: var(--primary-color); }
        .rank-group { margin-bottom: 30px; }
        .rank-group h4 { margin: 15px 0 10px; color: #555; font-size: 1.05rem; font-weight:bold; }
        .rank-list { list-style: none; padding: 0; }
        .rank-list li { padding: 12px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; color: var(--primary-color); font-weight: 500; }
        .rank-idx { background: var(--secondary-color); color: white; width: 28px; height: 28px; line-height: 28px; text-align: center; border-radius: 50%; display:inline-block; margin-right:10px; font-weight: bold; box-shadow: 1px 1px 3px rgba(0,0,0,0.2);}
        .color-cut { color: var(--danger-color); font-weight:900; }
        .color-freeze { color: var(--accent-color); font-weight:900; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 900px; max-height: 90vh; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: slideUp 0.3s ease-out; position:relative; display: flex; flex-direction: column; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header-area { padding: 30px; border-bottom: 1px solid #eee; position: relative; background-color: #fff; }
        .close-btn { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; cursor: pointer; color: #aaa; line-height: 0.8; z-index: 10; transition:0.2s; }
        .close-btn:hover { color: var(--danger-color); }
        .modal-tabs { display: flex; background: var(--bg-color); border-bottom: 2px solid var(--border-color); }
        .modal-tab { flex: 1; text-align: center; padding: 18px; cursor: pointer; font-weight: bold; color: #777; border-bottom: 4px solid transparent; transition: 0.3s; font-size: 1.05rem;}
        .modal-tab:hover { background: rgba(8, 103, 136, 0.05); color: var(--secondary-color); }
        .modal-tab.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); background: white; }
        .modal-body-area { padding: 30px; overflow-y: auto; max-height: calc(90vh - 180px); scroll-behavior: auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .modal-charts-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-top: 25px; }
        .mini-chart-box { text-align: center; background: #fff; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .mini-chart-box h4 { margin-top: 0; color: var(--secondary-color); }
        .desc-container { position: relative; max-height: 100px; overflow: hidden; transition: max-height 0.3s ease; }
        .desc-container.expanded { max-height: none; }
        .desc-gradient { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1)); pointer-events: none; }
        .desc-container.expanded .desc-gradient { display: none; }
        .toggle-btn { display: block; width: 100%; text-align: center; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 2px solid var(--secondary-color); border-radius: 8px; cursor: pointer; color: var(--secondary-color); font-weight: bold; transition: 0.2s; }
        .toggle-btn:hover { background: var(--secondary-color); color: white; }

        /* Loader & Error */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(248, 248, 248, 0.95); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #e0e0e0; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { text-align:center; padding: 20px; color: #E74C3C; background: #ffeaea; border-radius: 10px; border: 1px solid #E74C3C; max-width: 80%; }
        .demo-mode-badge { background: var(--warning-color); color: var(--primary-color); padding: 8px 16px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }

        /* Legislator */
        .filter-wrapper { text-align: center; margin-bottom: 30px; }
        .filter-btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; }
        .filter-tag { border: 2px solid var(--secondary-color); background: white; color: var(--secondary-color); padding: 8px 20px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .filter-tag:hover { background: var(--highlight-color); border-color: var(--highlight-color); color: var(--secondary-color); transform: translateY(-2px); }
        .filter-tag.active { background: var(--secondary-color); color: white; border-color: var(--secondary-color); box-shadow: 0 4px 8px rgba(8, 103, 136, 0.3); }
        .legislator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; margin-top: 25px; }
        .leg-card { background: white; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 2px solid var(--border-color); }
        .leg-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .leg-avatar { width: 110px; height: 110px; border-radius: 50%; background-color: var(--bg-color); margin-bottom: 20px; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; overflow: hidden; background-position: center; position: relative; }
        .leg-name { font-size: 1.5rem; font-weight: 900; margin-bottom: 8px; color: var(--primary-color); }
        .leg-party-tag { padding: 5px 15px; border-radius: 20px; color: white; font-size: 0.9rem; font-weight: bold; margin-bottom: 25px; display: inline-block; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .tag-kmt { background-color: var(--party-kmt); }
        .tag-dpp { background-color: var(--party-dpp); }
        .tag-tpp { background-color: var(--party-tpp); }
        .tag-npp { background-color: var(--party-npp); }
        .tag-other { background-color: var(--party-other); }
        .leg-stats-box { display: flex; justify-content: space-between; width: 100%; border-top: 2px solid #f0f0f0; padding-top: 20px; }
        .stat-item { flex: 1; text-align: center; }
        .stat-item:not(:last-child) { border-right: 2px solid #f0f0f0; }
        .stat-val { display: block; font-size: 1.4rem; font-weight: 900; color: var(--primary-color); }
        .stat-label { font-size: 0.85rem; color: #777; font-weight: bold; }
        .leg-modal-body { padding: 35px; overflow-y: auto; max-height: 90vh; }
        .leg-detail-header { text-align: center; margin-bottom: 40px; }
        .leg-detail-avatar { width: 130px; height: 130px; border-radius: 50%; background-color: var(--bg-color); margin: 0 auto 15px; border: 5px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background-position: center; display: flex; align-items: center; justify-content: center; font-size: 4.5rem; position: relative; overflow: hidden; }
        .leg-detail-table-title { border-left: 8px solid var(--secondary-color); padding-left: 15px; margin: 40px 0 20px 0; color: var(--primary-color); font-size: 1.3rem; }
        .title-cut { border-color: var(--danger-color); }
        .title-freeze { border-color: var(--accent-color); }
        .clickable-link { color: var(--secondary-color); cursor: pointer; text-decoration: underline; font-weight: bold; transition: 0.2s; }
        .clickable-link:hover { color: white; background-color: var(--secondary-color); border-radius: 4px; padding: 2px 6px; text-decoration: none; }
        .proposal-table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 1rem; }
        .proposal-table th, .proposal-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .proposal-table th { background-color: rgba(8, 103, 136, 0.05); color: var(--secondary-color); font-weight: bold; border-bottom: 2px solid var(--secondary-color); }
        .p-tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-right: 5px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .p-cut { background: var(--danger-color); }
        .p-freeze { background: var(--accent-color); color: var(--primary-color); }
        .jump-btn { background: var(--secondary-color); color: white; border: none; padding: 8px 18px; border-radius: 25px; cursor: pointer; font-size: 0.95rem; margin-top: 10px; display: inline-flex; align-items: center; transition: 0.3s; font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .jump-btn:hover { transform: translateY(-2px); box-shadow: 3px 3px 8px rgba(0,0,0,0.3); background-color: #0a7ea6; }
        .jump-btn::after { content: ' ➔'; margin-left: 5px; }

    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:var(--primary-color); font-weight:bold;">資料讀取中，請稍候...</p>
    </div>
    
    <div id="error-display" class="loading-overlay" style="display:none;">
        <div class="error-message">
            <h3>⚠️ 資料讀取失敗</h3>
            <p>無法連線至資料庫。Google 拒絕了連線請求。</p>
            <p style="font-size:0.9rem; margin-top:10px;">請確認：<br>1. FILE_ID 是否正確 (不是 2PACX 開頭)<br>2. 權限是否設為「知道連結的任何人 (Anyone with the link)」</p>
        </div>
    </div>

    <div id="unifiedModal" class="modal-overlay" onclick="closeModal(event, 'unifiedModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'unifiedModal')">&times;</span>
            <div class="modal-header-area">
                <h2 id="u-title" style="margin:0 0 10px 0; color:var(--primary-color); font-size:1.6rem;"></h2>
                <div>
                    <span id="u-dept" class="pb-dept"></span>
                    <span id="u-amount" style="font-weight:900; color:var(--secondary-color); margin-left:15px; font-size:1.3rem;"></span>
                </div>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('plan')">工作計畫內容</div>
                <div class="modal-tab" onclick="switchTab('review')">審查刪減結果</div>
            </div>
            <div class="modal-body-area">
                <div id="tab-content-plan" class="tab-content active">
                    <div style="background:var(--bg-color); padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid var(--border-color);">
                        <strong style="color:var(--secondary-color); font-size:1.1rem;">內容：</strong>
                        <div id="u-desc-container" class="desc-container" style="margin-top:10px;">
                            <span id="u-desc" style="color:#333;"></span>
                            <div class="desc-gradient"></div>
                        </div>
                        <button id="toggle-desc-btn" class="toggle-btn" onclick="toggleDesc()">展開閱讀全文</button>
                    </div>
                    <div class="modal-charts-grid">
                        <div class="mini-chart-box"><h4>分支計畫</h4><div style="height:250px;"><canvas id="chartDetailBar"></canvas></div></div>
                        <div class="mini-chart-box"><h4>用途比例</h4><div style="height:250px;"><canvas id="chartDetailPie"></canvas></div></div>
                    </div>
                </div>
                <div id="tab-content-review" class="tab-content">
                    <div id="review-data-container">
                        <div class="modal-charts-grid">
                            <div class="mini-chart-box"><h4>最終審查結果比例</h4><div style="height:250px;"><canvas id="chartBResult"></canvas></div></div>
                            <div class="mini-chart-box"><h4>三階段刪凍比較</h4><div style="height:250px;"><canvas id="chartBStages"></canvas></div></div>
                        </div>
                        <div style="margin-top: 35px;">
                            <h3 style="border-left: 8px solid var(--accent-color); padding-left: 15px; color:var(--primary-color);">委員提案紀錄</h3>
                            <div style="overflow-x: auto;">
                                <table class="proposal-table">
                                    <thead><tr><th style="width:18%">提案委員</th><th style="width:22%">類別/金額</th><th>提案理由</th></tr></thead>
                                    <tbody id="proposal-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="review-no-data" style="display:none; text-align:center; padding: 3rem; color:#999; font-size:1.1rem;">
                        <p>此計畫尚無審查刪減資料。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModalC" class="modal-overlay" onclick="closeModal(event, 'detailModalC')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal(null, 'detailModalC')">&times;</span>
            <div class="leg-modal-body">
                <div class="leg-detail-header">
                    <div id="mc-avatar" class="leg-detail-avatar"></div>
                    <h2 id="mc-name" style="color:var(--primary-color); margin-bottom:10px; font-size:1.8rem;"></h2>
                    <span id="mc-party" class="leg-party-tag"></span>
                </div>
                <h3 class="leg-detail-table-title title-cut">刪減案提案紀錄</h3>
                <div style="overflow-x: auto;">
                    <table class="proposal-table">
                        <thead><tr><th style="width:32%">刪減項目</th><th style="width:20%">刪減金額/比例</th><th>刪減理由</th></tr></thead>
                        <tbody id="table-cut-c"></tbody>
                    </table>
                </div>
                <h3 class="leg-detail-table-title title-freeze">凍結案提案紀錄</h3>
                <div style="overflow-x: auto;">
                    <table class="proposal-table">
                        <thead><tr><th style="width:32%">凍結項目</th><th style="width:20%">凍結金額/比例</th><th>凍結理由</th></tr></thead>
                        <tbody id="table-freeze-c"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <header>
        <h1 onclick="showPage('home')">中央政府總預算觀測站</h1>
        <nav>
            <button id="nav-home" onclick="showPage('home')">首頁</button>
            <button id="nav-budget" onclick="showPage('page-budget')">預算審查</button>
            <button id="nav-legislator" onclick="showPage('page-legislator')">立委把關</button>
        </nav>
    </header>

    <main>
        <section id="home" class="page-section active">
            <div class="hero">
                <h2 style="text-align: center; margin-bottom: 2.5rem; color:var(--primary-color); font-size:2rem; font-weight:900;">每一筆納稅錢，都值得被看見</h2>
            </div>
            
            <div id="demo-badge-home" class="demo-mode-badge" style="text-align:center;">⚠️ 目前顯示為測試資料 (無法連線至資料庫)</div>

            <div class="card" style="padding-bottom: 2.5rem;">
                <h3>總預算審查比例概況</h3>
                <div style="height: 100px; margin-bottom: 2rem;"><canvas id="chartStatusB"></canvas></div>
                <div style="text-align:center; font-size:0.95rem; color:#666; margin-bottom:2rem; font-weight:500;">說明：此圖表包含各工作計畫刪減與部會通案刪減之總和。</div>
                
                <div class="btn-group" style="margin-top:0; border-top:2px solid #f0f0f0; padding-top:2rem;">
                    <button class="big-btn btn-a" onclick="showPage('page-budget')">開始搜尋<br>預算與審查內容</button>
                    <button class="big-btn btn-c" onclick="showPage('page-legislator')">開始搜尋<br>立委把關紀錄</button>
                </div>
            </div>

            <div class="ranking-container">
                <div class="card rank-column">
                    <h3>部會機關 Top 5</h3>
                    <div class="rank-group"><h4>刪減金額最多</h4><ul class="rank-list" id="rank-dept-cut"></ul></div>
                    <div class="rank-group"><h4>凍結金額最多</h4><ul class="rank-list" id="rank-dept-freeze"></ul></div>
                </div>
                <div class="card rank-column">
                    <h3>工作計畫 Top 5</h3>
                    <div class="rank-group"><h4>刪減金額最多</h4><ul class="rank-list" id="rank-plan-cut"></ul></div>
                    <div class="rank-group"><h4>凍結金額最多</h4><ul class="rank-list" id="rank-plan-freeze"></ul></div>
                </div>
            </div>

            <div class="card">
                <h3>歷年歲出預算比較</h3>
                <div class="chart-container"><canvas id="chartYearly"></canvas></div>
            </div>
            
            <div class="card">
                <h3>115 年度預算分配概況</h3>
                <div class="bill-container">
                    <canvas id="chartAllocation"></canvas>
                </div>
                <div id="chartAllocationLegend" class="chart-legend"></div>
            </div>
        </section>

        <section id="page-budget" class="page-section">
            <h2 class="section-title">預算計畫與審查結果搜尋</h2>
            <div id="demo-badge-budget" class="demo-mode-badge" style="text-align:center;">⚠️ 測試資料模式：僅能搜尋「測試」或「國防」</div>
            <div class="search-wrapper"><input type="text" class="search-input-lg" placeholder="輸入關鍵字 (如: 國防, 潛艦, 凍結...)" oninput="handleSearchBudget(this.value)"></div>
            <div id="results-container-budget"><p align="center" style="color:#999; padding:30px; font-size:1.1rem;">請輸入關鍵字開始搜尋...</p></div>
        </section>

        <section id="page-legislator" class="page-section">
            <h2 class="section-title">立委把關紀錄</h2>
            <div id="demo-badge-leg" class="demo-mode-badge" style="text-align:center;">⚠️ 測試資料模式</div>
            <div class="filter-wrapper">
                <span style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">依黨籍篩選：</span>
                <div class="filter-btn-group">
                    <button class="filter-tag active" data-party="all" onclick="filterLegislators('all')">全部</button>
                    <button class="filter-tag" data-party="民進黨" onclick="filterLegislators('民進黨')">民進黨</button>
                    <button class="filter-tag" data-party="國民黨" onclick="filterLegislators('國民黨')">國民黨</button>
                    <button class="filter-tag" data-party="民眾黨" onclick="filterLegislators('民眾黨')">民眾黨</button>
                    <button class="filter-tag" data-party="時代力量" onclick="filterLegislators('時代力量')">時代力量</button>
                    <button class="filter-tag" data-party="無黨籍" onclick="filterLegislators('無黨籍')">無黨籍</button>
                </div>
            </div>
            <div class="card">
                <p style="text-align:center; color:#777; font-weight:500; margin-bottom:20px;">點擊委員卡片可查看詳細提案內容</p>
                <div class="legislator-grid" id="leg-container-c"></div>
            </div>
        </section>
    </main>

    <script>
        // ★★★ Query API 設定 (請填入您正確的 File ID) ★★★
        // 請務必確認這個 ID 對應的試算表權限是 "Anyone with the link"
        const FILE_ID = '1vS6ZFEMdgBFyC6O0Axmx7TvcckTzMoDCxrb5V_8gHJmyzBEXx'; 
        
        // 為了避免快取，我們在網址後面加亂數
        const getQueryUrl = (gid) => `https://docs.google.com/spreadsheets/d/${FILE_ID}/gviz/tq?tqx=out:json&tq&gid=${gid}&_=${new Date().getTime()}`;

        const dataSources = {
            'page-a': getQueryUrl('612819456'), 
            'page-b': getQueryUrl('1304436957'), 
            'page-c': getQueryUrl('1025885437') 
        };

        // Mock Data
        const MOCK_DATA_A=[{'計畫編號':'TEST001','計畫名稱':'國防自主強化計畫 (測試資料)','主管機關':'國防部','預算金額':'5000000000','工作內容':'這是測試用的計畫說明。','分支計畫':'潛艦國造:3000000000|無人機研發:2000000000','用途比例':'裝備採購:70|研發:30'}];
        const MOCK_DATA_B=[{'計畫編號':'TEST001','計畫名稱':'國防自主強化計畫 (測試資料)','主管機關':'國防部','預算金額':'5000000000','刪減金額':'1000000','凍結金額':'50000000','委員會刪減':'500000','委員會凍結':'20000000','協商刪減':'500000','協商凍結':'30000000','提案紀錄':'王小明:凍結:理由A|李小華:刪減:理由B','資料類型':'計畫'}];
        const MOCK_DATA_C=[{'委員姓名':'王小明 (測試)','黨籍':'無黨籍','刪減案數':'5','凍結案數':'10','主決議數':'2','照片':'','提案明細':'刪減#國防自主強化計畫 (測試資料)#100萬#理由B#TEST001'}];
        
        let allDataPageA = [], allDataPageB = [], allDataPageB_Plans = [], allDataPageC = []; 
        let mainChartsRendered = false;
        let isDemoMode = false;

        window.addEventListener('DOMContentLoaded', () => {
            renderMainCharts();
            Promise.all([
                fetchData('page-a', true),
                fetchData('page-b', true),
                fetchData('page-c', true)
            ]).then(() => {
                if(isDemoMode) {
                    document.querySelectorAll('.demo-mode-badge').forEach(el => el.style.display = 'block');
                }
            });
        });

        // 核心邏輯
        function parseMoney(str) {
            if(!str) return 0;
            let s = str + '';
            let val = parseFloat(s.replace(/,/g, '').replace(/[^0-9.-]/g, ''));
            if (isNaN(val)) return 0;
            if (s.includes('億')) return val * 100000000;
            else if (s.includes('萬')) return val * 10000;
            else return val * 1000;
        }
        function formatCurrency(num) {
            let val = parseFloat(num);
            if (isNaN(val) || val === 0) return "0";
            let absVal = Math.abs(val);
            if (absVal >= 1000000000000) return (val / 1000000000000).toFixed(1).replace(/\.0$/, '') + "兆";
            else if (absVal >= 100000000) return (val / 100000000).toFixed(1).replace(/\.0$/, '') + "億";
            else if (absVal >= 10000) return (val / 10000).toFixed(1).replace(/\.0$/, '') + "萬";
            else return val.toLocaleString() + "元";
        }
        const tooltipCurrencyCallback = {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    let value = context.raw;
                    if (value !== null && value !== undefined) { label += formatCurrency(value); }
                    return label;
                }
            }
        };

        // Query API Response Parser
        function parseQueryResponse(jsonData) {
            const table = jsonData.table;
            const cols = table.cols.map(c => c.label).filter(l => l !== '');
            const rows = table.rows;
            
            return rows.map(row => {
                let obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) {
                        obj[cols[i]] = cell ? (cell.v !== null ? String(cell.v) : '') : '';
                    }
                });
                return obj;
            });
        }

        // Fetch Data (Query API)
        async function fetchData(pageId, silent = false) {
            const loader = document.getElementById('loader');
            const errorDisplay = document.getElementById('error-display');
            
            let targetUrl = dataSources[pageId];
            if(pageId === 'page-budget') return []; 
            if(pageId === 'page-legislator') targetUrl = dataSources['page-c'];

            if (!silent) loader.style.display = 'flex';

            try {
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                
                // 檢查是否被導向登入頁面
                if (text.includes('<!DOCTYPE html>') || text.includes('google.com/accounts')) {
                    throw new Error("Login Page Detected (Permissions Error)");
                }

                const jsonText = text.substring(47, text.length - 2);
                const jsonData = JSON.parse(jsonText);
                
                if (jsonData.status === 'error') {
                    throw new Error("Google Query API Error: " + JSON.stringify(jsonData.errors));
                }

                let cleanData = parseQueryResponse(jsonData);

                if (pageId === 'page-a') { allDataPageA = cleanData; } 
                else if (pageId === 'page-b') { allDataPageB = cleanData; processPageBData(allDataPageB); } 
                else if (pageId === 'page-c') { allDataPageC = cleanData; filterLegislators('all'); }

                if (!silent) loader.style.display = 'none';
                return cleanData;

            } catch (error) {
                console.warn(`[${pageId}] Fetch failed, using Mock Data.`, error);
                
                isDemoMode = true; 
                let mockData = [];
                if (pageId === 'page-a') { mockData = MOCK_DATA_A; allDataPageA = mockData; }
                else if (pageId === 'page-b') { mockData = MOCK_DATA_B; allDataPageB = mockData; processPageBData(mockData); }
                else if (pageId === 'page-c') { mockData = MOCK_DATA_C; allDataPageC = mockData; filterLegislators('all'); }
                
                if (!silent) {
                    loader.style.display = 'none';
                    if(errorDisplay) {
                        errorDisplay.style.display = 'flex';
                        // 讓使用者知道發生了什麼事
                        if (error.message.includes("Login Page")) {
                            errorDisplay.innerHTML = `<div class="error-message"><h3>⚠️ 權限錯誤</h3><p>Google 試算表要求登入。</p><p>請務必將試算表共用權限設為「知道連結的任何人 (檢視者)」</p><p>並確認 FILE_ID 正確。</p></div>`;
                        }
                    }
                    document.querySelectorAll('.demo-mode-badge').forEach(el => el.style.display = 'block');
                }
                return mockData;
            }
        }

        // ... (以下所有圖表與邏輯函式保持不變) ...
        function filterLegislators(party) {
            document.querySelectorAll('.filter-tag').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.party === party) btn.classList.add('active');
            });
            let filtered = [];
            if (party === 'all') { filtered = allDataPageC; } 
            else { filtered = allDataPageC.filter(r => (r['黨籍'] || '').includes(party)); }
            renderLegislatorGrid(filtered);
        }

        function processPageBData(data){
            let totalCut=0,totalFreeze=0,totalBudget=0;let deptStats={};allDataPageB_Plans=[];
            data.forEach(row=>{
                const amount=parseMoney(row['預算金額']);const cut=parseMoney(row['刪減金額']);const freeze=parseMoney(row['凍結金額']);const dept=row['主管機關']||'其他';const type=row['資料類型']||'計畫';
                totalBudget+=amount;totalCut+=cut;totalFreeze+=freeze;
                if(!deptStats[dept])deptStats[dept]={name:dept,cut:0,freeze:0};deptStats[dept].cut+=cut;deptStats[dept].freeze+=freeze;
                if(type==='計畫'){allDataPageB_Plans.push(row)}
            });
            const totalPass=totalBudget-totalCut-totalFreeze;
            const ctxStatus = document.getElementById('chartStatusB');
            if (ctxStatus) {
                new Chart(ctxStatus.getContext('2d'),{type:'bar',data:{labels:['總體審查結果'],datasets:[{label:'通過',data:[totalPass],backgroundColor:'#086788',barThickness:40},{label:'凍結',data:[totalFreeze],backgroundColor:'#F0C808',barThickness:40},{label:'刪減',data:[totalCut],backgroundColor:'#E74C3C',barThickness:40}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,display:false},y:{stacked:true,display:false}},plugins:{legend:{position:'top'},tooltip:tooltipCurrencyCallback}}});
            }
            const deptArray=Object.values(deptStats);renderRankList('rank-dept-cut',[...deptArray].sort((a,b)=>b.cut-a.cut).slice(0,5),'cut');renderRankList('rank-dept-freeze',[...deptArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5),'freeze');
            const planArray=allDataPageB_Plans.map(r=>({name:r['計畫名稱'],cut:parseMoney(r['刪減金額']),freeze:parseMoney(r['凍結金額'])})).filter(r=>r.name);renderRankList('rank-plan-cut',[...planArray].sort((a,b)=>b.cut-a.cut).slice(0,5),'cut');renderRankList('rank-plan-freeze',[...planArray].sort((a,b)=>b.freeze-a.freeze).slice(0,5),'freeze');
        }
        function renderRankList(elementId,list,type){const el=document.getElementById(elementId);if(!list||list.length===0){el.innerHTML='<li style="color:#999;">無資料</li>';return}let html='';list.forEach((item,index)=>{let val=type==='cut'?item.cut:item.freeze;let valDisplay=formatCurrency(val);let colorClass=type==='cut'?'color-cut':'color-freeze';html+=`<li><span><span class="rank-idx">${index+1}</span> ${item.name}</span><span class="rank-val ${colorClass}">${valDisplay}</span></li>`});el.innerHTML=html}

        function handleSearchBudget(val) {
            const container = document.getElementById('results-container-budget');
            if (!val.trim()) { 
                container.innerHTML = '<p align="center" style="color:#999; padding:30px; font-size:1.1rem;">請輸入關鍵字開始搜尋...</p>'; 
                return; 
            }
            const keywords = val.toLowerCase().replace(/\s+and\s+/g, ' ').split(/\s+/).filter(k => k.trim() !== '');
            const filtered = allDataPageA.filter(r => {
                const content = ((r['計畫名稱'] || '') + (r['工作內容'] || '') + (r['主管機關'] || '')).toLowerCase();
                return keywords.every(k => content.includes(k));
            });
            displayUnifiedBlocks(filtered);
        }

        function displayUnifiedBlocks(data){
            const container=document.getElementById('results-container-budget');
            if(!data||data.length===0){container.innerHTML='<p align="center" style="color:#999; padding:30px; font-size:1.1rem;">查無資料</p>';return}
            let html='';
            data.forEach(row=>{
                const id = row['計畫編號'];
                const amountRaw=parseMoney(row['預算金額']);
                html+=`<div class="project-block" onclick="openUnifiedDetail('${id}')"><div class="pb-info"><h3 class="pb-title">${row['計畫名稱']}</h3><span class="pb-dept">${row['主管機關']}</span></div><div class="pb-amount">${formatCurrency(amountRaw)}</div></div>`
            });
            container.innerHTML=html;
        }

        let chartBarA = null, chartPieA = null, chartB1 = null, chartB2 = null;
        function openUnifiedDetail(id) {
            const planData = allDataPageA.find(r => r['計畫編號'] === id);
            const reviewData = allDataPageB.find(r => r['計畫編號'] === id);
            if (!planData && !reviewData) { alert("資料讀取錯誤：找不到該計畫 (請檢查計畫編號是否正確)"); return; }
            const baseData = planData || reviewData; 
            document.getElementById('u-title').innerText = baseData['計畫名稱'];
            document.getElementById('u-dept').innerText = baseData['主管機關'];
            document.getElementById('u-amount').innerText = formatCurrency(parseMoney(baseData['預算金額']));
            
            // Tab A (Plan)
            if (planData) {
                document.getElementById('u-desc').innerText = planData['工作內容'] || '無';
                document.getElementById('u-desc-container').classList.remove('expanded');
                document.getElementById('toggle-desc-btn').innerText = '展開閱讀全文';
                if(chartBarA) chartBarA.destroy(); if(chartPieA) chartPieA.destroy();
                renderDetailChartsA(planData);
            } else { document.getElementById('u-desc').innerText = '此計畫無詳細編列內容資料。'; }
            
            // Tab B (Review)
            const reviewContainer = document.getElementById('review-data-container');
            const reviewNoData = document.getElementById('review-no-data');
            if (reviewData) {
                reviewContainer.style.display = 'block'; reviewNoData.style.display = 'none';
                if(chartB1) chartB1.destroy(); if(chartB2) chartB2.destroy();
                renderDetailChartsB(reviewData); 
                renderProposalTable(reviewData);
            } else { reviewContainer.style.display = 'none'; reviewNoData.style.display = 'block'; }
            
            setTimeout(() => {
                const modalBody = document.querySelector('#unifiedModal .modal-body-area');
                if (modalBody) modalBody.scrollTop = 0;
            }, 0);

            switchTab('plan'); document.getElementById('unifiedModal').style.display = 'flex';
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tabName === 'plan') {
                document.querySelector('.modal-tab:first-child').classList.add('active');
                document.getElementById('tab-content-plan').classList.add('active');
            } else {
                document.querySelector('.modal-tab:last-child').classList.add('active');
                document.getElementById('tab-content-review').classList.add('active');
            }
            setTimeout(() => {
                const modalBody = document.querySelector('#unifiedModal .modal-body-area');
                if (modalBody) modalBody.scrollTop = 0;
            }, 0);
        }

        async function jumpToProjectB(projectId) {
            const loader = document.getElementById('loader'); loader.style.display = 'flex';
            closeModal(null, 'detailModalC'); showPage('page-budget');
            if(allDataPageA.length === 0) await fetchData('page-a', true);
            if(allDataPageB.length === 0) await fetchData('page-b', true);
            const targetId = String(projectId).trim(); openUnifiedDetail(targetId); switchTab('review');
            loader.style.display = 'none';
        }

        async function jumpToC(name) {
            const loader = document.getElementById('loader'); loader.style.display = 'flex';
            closeModal(null, 'unifiedModal'); 
            if(allDataPageC.length === 0) { try { await fetchData('page-c'); } catch(e) { loader.style.display = 'none'; return; } }
            const targetName = String(name).trim();
            const target = allDataPageC.find(r => String(r['委員姓名']).trim() === targetName);
            loader.style.display = 'none';
            if(target) { const str = encodeURIComponent(JSON.stringify(target)); openDetailC(str); } 
            else { alert(`查無此委員資料 (${targetName})`); }
        }

        function closeModal(e,modalId){if(e&&e.target!==e.currentTarget&&e.target.className!=='close-btn')return;document.getElementById(modalId).style.display='none'}

        function renderDetailChartsA(row){
            let subLabels=[],subData=[];
            let branchString=row['分支計畫']||'';
            if(branchString&&branchString.includes(':')){
                branchString.split('|').forEach(item=>{
                    let parts=item.split(':');
                    if(parts.length===2){subLabels.push(parts[0].trim());subData.push(parseMoney(parts[1].trim()))}
                })
            }
            let pieLabels=[],pieData=[];
            let usageString=row['用途比例']||'';
            if(usageString&&usageString.includes(':')){
                usageString.split('|').forEach(item=>{
                    let parts=item.split(':');
                    if(parts.length===2){pieLabels.push(parts[0].trim());pieData.push(parseInt(parts[1].trim()))}
                })
            }
            const ctxBar=document.getElementById('chartDetailBar').getContext('2d');
            chartBarA=new Chart(ctxBar,{type:'bar',data:{labels:subLabels,datasets:[{label:'金額',data:subData,backgroundColor:'#086788',borderRadius:4}]},options:{indexAxis:'y',maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:tooltipCurrencyCallback}}});
            const ctxPie=document.getElementById('chartDetailPie').getContext('2d');
            chartPieA=new Chart(ctxPie,{type:'pie',data:{labels:pieLabels,datasets:[{data:pieData,backgroundColor:['#E74C3C','#F0C808','#086788','#2ECC71','#9B59B6']}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:tooltipCurrencyCallback}}});
        }

        function renderDetailChartsB(row){
            const total=parseMoney(row['預算金額']);
            const cut=parseMoney(row['刪減金額']);
            const freeze=parseMoney(row['凍結金額']);
            const pass=total-cut-freeze;
            const ctx1=document.getElementById('chartBResult').getContext('2d');
            chartB1=new Chart(ctx1,{type:'bar',data:{labels:['結果'],datasets:[{label:'通過',data:[pass],backgroundColor:'#086788'},{label:'凍結',data:[freeze],backgroundColor:'#F0C808'},{label:'刪減',data:[cut],backgroundColor:'#E74C3C'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}},plugins:{tooltip:tooltipCurrencyCallback}}});
            const cCut=parseMoney(row['委員會刪減']);const cFreeze=parseMoney(row['委員會凍結']);const nCut=parseMoney(row['協商刪減']);const nFreeze=parseMoney(row['協商凍結']);const fCut=parseMoney(row['院會刪減']);const fFreeze=parseMoney(row['院會凍結']);
            const ctx2=document.getElementById('chartBStages').getContext('2d');
            chartB2=new Chart(ctx2,{type:'bar',data:{labels:['委員會','黨團協商','院會'],datasets:[{label:'刪減',data:[cCut,nCut,fCut],backgroundColor:'#E74C3C'},{label:'凍結',data:[cFreeze,nFreeze,fFreeze],backgroundColor:'#F0C808'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:tooltipCurrencyCallback}}});
        }

        function renderMainCharts(){
            if(mainChartsRendered)return;
            new Chart(document.getElementById('chartYearly').getContext('2d'),{
                type:'bar',
                data:{
                    labels:['115年度','114年度','113年度','112年度','111年度','110年度','109年度','108年度','107年度','106年度'],
                    datasets:[{
                        label:'歲出總額',
                        data:[3034974371000,3132468909000,2881782095000,2719098790000,2262064189000,2161517070000,2102196982000,2022029637000,1991773071000,1997995520000],
                        backgroundColor:'#086788'
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{ tooltip: tooltipCurrencyCallback },
                    scales: {
                        y: { ticks: { callback: function(value) { return formatCurrency(value); } } }
                    }
                }
            });

            const chartData = {
                labels:['115年度預算結構'],
                datasets:[
                    { label:'社會福利', data:[831800000000], backgroundColor: 'rgba(231, 76, 60, 0.5)' }, 
                    { label:'教育科學文化', data:[556600000000], backgroundColor: 'rgba(240, 200, 8, 0.5)' }, 
                    { label:'國防', data:[548800000000], backgroundColor: 'rgba(8, 103, 136, 0.5)' }, 
                    { label:'經濟發展', data:[427500000000], backgroundColor: 'rgba(46, 204, 113, 0.5)' }, 
                    { label:'一般政務', data:[302600000000], backgroundColor: 'rgba(155, 89, 182, 0.5)' }, 
                    { label:'退休撫卹', data:[184400000000], backgroundColor: 'rgba(52, 152, 219, 0.5)' }, 
                    { label:'債務還本付息', data:[106300000000], backgroundColor: 'rgba(230, 126, 34, 0.5)' }, 
                    { label:'補助及其他', data:[50400000000], backgroundColor: 'rgba(26, 188, 156, 0.5)' }, 
                    { label:'社區發展及環境保護', data:[26600000000], backgroundColor: 'rgba(52, 73, 94, 0.5)' } 
                ]
            };

            const ctx = document.getElementById('chartAllocation').getContext('2d');
            const allValues = chartData.datasets.map(ds => ds.data[0]);
            const totalBudget = allValues.reduce((acc, curr) => acc + curr, 0);

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { stacked: true, display: false, min: 0, max: totalBudget },
                        y: { stacked: true, display: false }
                    },
                    plugins: { legend: { display: false }, tooltip: tooltipCurrencyCallback },
                    layout: { padding: 0 },
                    categoryPercentage: 1.0,
                    barPercentage: 1.0
                }
            });
            
            const legendContainer = document.getElementById('chartAllocationLegend');
            if(legendContainer) {
                let legendHtml = '';
                chartData.datasets.forEach(ds => {
                    let color = ds.backgroundColor.replace('0.7', '1'); 
                    legendHtml += `<div class="legend-item"><div class="legend-color-box" style="background-color:${color}; box-shadow: none; border:none;"></div><span>${ds.label}</span></div>`;
                });
                legendContainer.innerHTML = legendHtml;
            }
            
            mainChartsRendered=true;
        }
    </script>
</body>
</html>
